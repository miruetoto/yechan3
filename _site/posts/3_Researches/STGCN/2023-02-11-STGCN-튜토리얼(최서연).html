<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="신록예찬, 최서연">
<meta name="dcterms.date" content="2022-12-30">

<title>신록예찬’s Blog - 튜토리얼: 공식홈페이지 데이터셋 정리</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">신록예찬’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://guebin.github.io/DL2022/">
 <span class="menu-text">DL2022</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://guebin.github.io/DV2022/">
 <span class="menu-text">DV2022</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://guebin.github.io/IP2022/">
 <span class="menu-text">IP2022</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://guebin.github.io/SC2022/">
 <span class="menu-text">SC2022</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://guebin.github.io/DS2022/">
 <span class="menu-text">DS2022</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://guebin.github.io/IR2021/">
 <span class="menu-text">IR2021</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://miruetoto.github.io/yechan/">
 <span class="menu-text">yechan</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://miruetoto.github.io/yechan2/">
 <span class="menu-text">yechan2</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/miruetoto/yechan3"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">튜토리얼: 공식홈페이지 데이터셋 정리</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title d-none d-lg-block">튜토리얼: 공식홈페이지 데이터셋 정리</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>신록예찬, 최서연 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 30, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../1_essays.html" class="sidebar-item-text sidebar-link">Essays</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Let’s Study</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../2_cgsp.html" class="sidebar-item-text sidebar-link">CGSP</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../2_python.html" class="sidebar-item-text sidebar-link">Python</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../2_pl.html" class="sidebar-item-text sidebar-link">PyTorch Lightning</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../2_reviews.html" class="sidebar-item-text sidebar-link">Reviews</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../2_notes.html" class="sidebar-item-text sidebar-link">Notes</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Researches</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../3_hst.html" class="sidebar-item-text sidebar-link">HST</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../3_stgcn.html" class="sidebar-item-text sidebar-link">STGCN</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about-this-doc" id="toc-about-this-doc" class="nav-link active" data-scroll-target="#about-this-doc">About this doc</a></li>
  <li><a href="#ref" id="toc-ref" class="nav-link" data-scroll-target="#ref">ref</a></li>
  <li><a href="#imports" id="toc-imports" class="nav-link" data-scroll-target="#imports">imports</a></li>
  <li><a href="#stgcn-데이터-개념" id="toc-stgcn-데이터-개념" class="nav-link" data-scroll-target="#stgcn-데이터-개념">STGCN 데이터 개념</a></li>
  <li><a href="#사용하는-자료의-타입" id="toc-사용하는-자료의-타입" class="nav-link" data-scroll-target="#사용하는-자료의-타입">사용하는 자료의 타입</a>
  <ul class="collapse">
  <li><a href="#pyg-의-data-자료형" id="toc-pyg-의-data-자료형" class="nav-link" data-scroll-target="#pyg-의-data-자료형">PyG 의 Data 자료형</a></li>
  <li><a href="#pytorch-geometric-temporal-의-자료형" id="toc-pytorch-geometric-temporal-의-자료형" class="nav-link" data-scroll-target="#pytorch-geometric-temporal-의-자료형">PyTorch Geometric Temporal 의 자료형</a></li>
  </ul></li>
  <li><a href="#데이터셋" id="toc-데이터셋" class="nav-link" data-scroll-target="#데이터셋">데이터셋</a>
  <ul class="collapse">
  <li><a href="#chickenpoxdatasetloader" id="toc-chickenpoxdatasetloader" class="nav-link" data-scroll-target="#chickenpoxdatasetloader">ChickenpoxDatasetLoader</a>
  <ul class="collapse">
  <li><a href="#데이터정리" id="toc-데이터정리" class="nav-link" data-scroll-target="#데이터정리">데이터정리</a></li>
  </ul></li>
  <li><a href="#pedalmedatasetloader" id="toc-pedalmedatasetloader" class="nav-link" data-scroll-target="#pedalmedatasetloader">PedalMeDatasetLoader</a></li>
  <li><a href="#wikimathsdatasetloader" id="toc-wikimathsdatasetloader" class="nav-link" data-scroll-target="#wikimathsdatasetloader">WikiMathsDatasetLoader</a></li>
  <li><a href="#windmilloutputlargedatasetloader" id="toc-windmilloutputlargedatasetloader" class="nav-link" data-scroll-target="#windmilloutputlargedatasetloader">WindmillOutputLargeDatasetLoader</a></li>
  <li><a href="#windmilloutputmediumdatasetloader" id="toc-windmilloutputmediumdatasetloader" class="nav-link" data-scroll-target="#windmilloutputmediumdatasetloader">WindmillOutputMediumDatasetLoader</a></li>
  <li><a href="#windmilloutputsmalldatasetloader" id="toc-windmilloutputsmalldatasetloader" class="nav-link" data-scroll-target="#windmilloutputsmalldatasetloader">WindmillOutputSmallDatasetLoader</a></li>
  <li><a href="#metrladatasetloader_real-world-traffic-dataset" id="toc-metrladatasetloader_real-world-traffic-dataset" class="nav-link" data-scroll-target="#metrladatasetloader_real-world-traffic-dataset">METRLADatasetLoader_real world traffic dataset</a></li>
  <li><a href="#pemsbaydatasetloader" id="toc-pemsbaydatasetloader" class="nav-link" data-scroll-target="#pemsbaydatasetloader">PemsBayDatasetLoader</a></li>
  <li><a href="#englandcoviddatasetloader" id="toc-englandcoviddatasetloader" class="nav-link" data-scroll-target="#englandcoviddatasetloader">EnglandCovidDatasetLoader</a></li>
  <li><a href="#montevideobusdatasetloader" id="toc-montevideobusdatasetloader" class="nav-link" data-scroll-target="#montevideobusdatasetloader">MontevideoBusDatasetLoader</a></li>
  <li><a href="#twittertennisdatasetloader" id="toc-twittertennisdatasetloader" class="nav-link" data-scroll-target="#twittertennisdatasetloader">TwitterTennisDatasetLoader</a></li>
  <li><a href="#mtmdatasetloader" id="toc-mtmdatasetloader" class="nav-link" data-scroll-target="#mtmdatasetloader">MTMDatasetLoader</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="about-this-doc" class="level1">
<h1>About this doc</h1>
<p><code>-</code> 이 문서는 공식홈페이지의 예제와 최서연학생의 블로그 내용을 재구성하여 만듬</p>
<p><code>-</code> 이 문서의 목표는 아래와 같다.</p>
<ul>
<li>STGCN을 사용할 수 있는 데이터의 형태를 탐구한다.</li>
<li>STGCN을 실습할 코드를 확보한다.</li>
</ul>
</section>
<section id="ref" class="level1">
<h1>ref</h1>
<ul>
<li><a href="https://pytorch-geometric.readthedocs.io/en/latest/index.html#">PyG 공식홈페이지</a> // <code>torch_geometric</code></li>
<li><a href="https://pytorch-geometric-temporal.readthedocs.io/en/latest/index.html">PyTorch Geometric Temporal 공식홈페이지</a> // <code>torch_geometric_temporal</code></li>
<li><a href="https://github.com/seoyeonc/blog/blob/main/posts/GCN/2022-12-21-st-gcn%20Dataset.ipynb">최서연 블로그</a></li>
</ul>
<p>참고: <code>torch</code> 를 기반으로 <code>PyG</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>이 만들어 졌고 <code>PyG</code>를 기반으로 <code>PyTorch Geometric Temporal</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>가 만들어짐.</p>
</section>
<section id="imports" class="level1">
<h1>imports</h1>
<p><code>-</code> 필요한 패키지 임포트</p>
<div class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># 일반적인 모듈 </span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt </span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> networkx <span class="im">as</span> nx </span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm </span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co"># 파이토치 관련 </span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="im">import</span> torch</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co"># PyG 관련 </span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="im">from</span> torch_geometric.data <span class="im">import</span> Data</span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co"># STGCN 관련 </span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="im">import</span> torch_geometric_temporal</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="im">from</span> torch_geometric_temporal.nn.recurrent <span class="im">import</span> GConvGRU</span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>tdqm</code>: for문의 진행상태를 확인하기 위한 패키지</li>
<li><code>networkx</code>: 그래프 시그널 시각화를 위한 모듈</li>
<li><code>torch</code>: 파이토치 (STGCN은 파이토치 기반으로 만들어짐) 모듈</li>
<li><code>torch.nn.functional</code>: relu 등의 활성화함수를 불러오기 위한 모듈</li>
<li><code>Data</code>: 그래프자료를 만들기 위한 클래스</li>
<li><code>GConvGRU</code>: STGCN layer를 만드는 클래스</li>
<li><code>temporal_signal_split</code>: STGCN dataset 을 train/test 형태로 분리하는 기능이 있는 “함수”</li>
</ul>
<p><code>-</code> STGCN의 학습을 위한 클래스선언</p>
<div class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">class</span> RecurrentGCN(torch.nn.Module):</span>
<span id="cb2-2"><a href="#cb2-2"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, node_features, filters):</span>
<span id="cb2-3"><a href="#cb2-3"></a>        <span class="bu">super</span>(RecurrentGCN, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb2-4"><a href="#cb2-4"></a>        <span class="va">self</span>.recurrent <span class="op">=</span> GConvGRU(node_features, filters, <span class="dv">2</span>)</span>
<span id="cb2-5"><a href="#cb2-5"></a>        <span class="va">self</span>.linear <span class="op">=</span> torch.nn.Linear(filters, <span class="dv">1</span>)</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, edge_index, edge_weight):</span>
<span id="cb2-8"><a href="#cb2-8"></a>        h <span class="op">=</span> <span class="va">self</span>.recurrent(x, edge_index, edge_weight)</span>
<span id="cb2-9"><a href="#cb2-9"></a>        h <span class="op">=</span> F.relu(h)</span>
<span id="cb2-10"><a href="#cb2-10"></a>        h <span class="op">=</span> <span class="va">self</span>.linear(h)</span>
<span id="cb2-11"><a href="#cb2-11"></a>        <span class="cf">return</span> h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="stgcn-데이터-개념" class="level1">
<h1>STGCN 데이터 개념</h1>
<p><code>-</code> 시계열: each <span class="math inline">\(t\)</span> 에 대한 observation이 하나의 값 (혹은 벡터)</p>
<ul>
<li>자료: <span class="math inline">\(X(t)\)</span> for <span class="math inline">\(t=1,2,\dots,T\)</span></li>
</ul>
<p><code>-</code> STGCN setting에서는 each <span class="math inline">\(t\)</span> 에 대한 observation이 graph</p>
<ul>
<li>자료, <span class="math inline">\(X(v,t)\)</span> for <span class="math inline">\(t=1,2,\dots,T\)</span> and <span class="math inline">\(v \in V\)</span></li>
<li>여기에서는 <span class="math inline">\(X(v,t)\)</span> 대신에 <span class="math inline">\(f(v,t)\)</span>로 표현</li>
</ul>
</section>
<section id="사용하는-자료의-타입" class="level1">
<h1>사용하는 자료의 타입</h1>
<section id="pyg-의-data-자료형" class="level2">
<h2 class="anchored" data-anchor-id="pyg-의-data-자료형">PyG 의 Data 자료형</h2>
<blockquote class="blockquote">
<p>ref: <a href="https://pytorch-geometric.readthedocs.io/en/latest/notes/introduction.html#data-handling-of-graphs" class="uri">https://pytorch-geometric.readthedocs.io/en/latest/notes/introduction.html#data-handling-of-graphs</a></p>
</blockquote>
<p><code>-</code> 자료는 <a href="https://pytorch-geometric.readthedocs.io/en/latest/notes/introduction.html#data-handling-of-graphs">PyG의 Data 오브젝트</a>를 기반으로 한다.</p>
<p>(예제) 아래와 같은 그래프자료를 고려하자.</p>
<p><img src="https://pytorch-geometric.readthedocs.io/en/latest/_images/graph.svg" class="img-fluid"></p>
<p>이러한 자료형은 아래와 같은 형식으로 저장한다.</p>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>edge_index <span class="op">=</span> torch.tensor([[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb3-2"><a href="#cb3-2"></a>                           [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>]], dtype<span class="op">=</span>torch.<span class="bu">long</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a>x <span class="op">=</span> torch.tensor([[<span class="op">-</span><span class="dv">1</span>], [<span class="dv">0</span>], [<span class="dv">1</span>]], dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb3-4"><a href="#cb3-4"></a>data <span class="op">=</span> Data(x<span class="op">=</span>x, edge_index<span class="op">=</span>edge_index) <span class="co"># Data는 그래프자료형을 만드는 클래스</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="bu">type</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="115">
<pre><code>torch_geometric.data.data.Data</code></pre>
</div>
</div>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>data.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>tensor([[-1.],
        [ 0.],
        [ 1.]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a>data.edge_index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>tensor([[0, 1, 1, 2],
        [1, 0, 2, 1]])</code></pre>
</div>
</div>
</section>
<section id="pytorch-geometric-temporal-의-자료형" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-geometric-temporal-의-자료형">PyTorch Geometric Temporal 의 자료형</h2>
<blockquote class="blockquote">
<p>ref: <a href="https://pytorch-geometric-temporal.readthedocs.io/en/latest/modules/signal.html#torch_geometric_temporal.signal.static_graph_temporal_signal.StaticGraphTemporalSignal">PyTorch Geometric Temporal Signal</a></p>
</blockquote>
<p>아래의 클래스들중 하나를 이용하여 만든다.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a><span class="co">## Temporal Signal Iterators</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>torch_geometric_temporal.signal.StaticGraphTemporalSignal</span>
<span id="cb10-3"><a href="#cb10-3"></a>torch_geometric_temporal.signal.DynamicGraphTemporalSignal</span>
<span id="cb10-4"><a href="#cb10-4"></a>torch_geometric_temporal.signal.DynamicGraphStaticSignal</span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co">## Heterogeneous Temporal Signal Iterators</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>torch_geometric_temporal.signal.StaticHeteroGraphTemporalSignal</span>
<span id="cb10-7"><a href="#cb10-7"></a>torch_geometric_temporal.signal.DynamicHeteroGraphTemporalSignal</span>
<span id="cb10-8"><a href="#cb10-8"></a>torch_geometric_temporal.signal.DynamicHeteroGraphStaticSignal</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>이중 “Heterogeneous Temporal Signal” 은 우리가 관심이 있는 신호가 아니므로 사실상 아래의 3개만 고려하면 된다.</p>
<ul>
<li><code>torch_geometric_temporal.signal.StaticGraphTemporalSignal</code></li>
<li><code>torch_geometric_temporal.signal.DynamicGraphTemporalSignal</code></li>
<li><code>torch_geometric_temporal.signal.DynamicGraphStaticSignal</code></li>
</ul>
<p>여기에서 <code>StaticGraphTemporalSignal</code> 는 시간에 따라서 그래프 구조가 일정한 경우, 즉 <span class="math inline">\({\cal G}_t=\{{\cal V},{\cal E}\}\)</span>와 같은 구조를 의미한다.</p>
<p><strong>(예제1)</strong></p>
<p><code>-</code> json data <span class="math inline">\(\to\)</span> dict</p>
<div class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="im">import</span> json</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="im">import</span> urllib</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/benedekrozemberczki/pytorch_geometric_temporal/master/dataset/chickenpox.json"</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>data_dict <span class="op">=</span> json.loads(urllib.request.urlopen(url).read())</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="co"># data_dict 출력이 김</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>data_dict.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="162">
<pre><code>dict_keys(['edges', 'node_ids', 'FX'])</code></pre>
</div>
</div>
<p><code>-</code> 살펴보기</p>
<div class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>np.array(data_dict[<span class="st">'edges'</span>]).T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="165">
<pre><code>array([[ 0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  2,  2,  2,  2,  3,
         3,  3,  3,  3,  3,  4,  4,  5,  5,  5,  5,  6,  6,  6,  6,  6,
         6,  6,  7,  7,  7,  7,  8,  8,  8,  8,  8,  9,  9,  9,  9,  9,
        10, 10, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 12, 12, 12,
        12, 13, 13, 13, 13, 13, 13, 13, 13, 14, 14, 14, 14, 14, 14, 15,
        15, 15, 16, 16, 16, 16, 16, 17, 17, 17, 17, 18, 18, 18, 18, 18,
        18, 18, 19, 19, 19, 19],
       [10,  6, 13,  1,  0,  5, 16,  0, 16,  1, 14, 10,  8,  2,  5,  8,
        15, 12,  9, 10,  3,  4, 13,  0, 10,  2,  5,  0, 16,  6, 14, 13,
        11, 18,  7, 17, 11, 18,  3,  2, 15,  8, 10,  9, 13,  3, 12, 10,
         5,  9,  8,  3, 10,  2, 13,  0,  6, 11,  7, 13, 18,  3,  9, 13,
        12, 13,  9,  6,  4, 12,  0, 11, 10, 18, 19,  1, 14,  6, 16,  3,
        15,  8, 16, 14,  1,  0,  6,  7, 19, 17, 18, 14, 18, 17,  7,  6,
        19, 11, 18, 14, 19, 17]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>data_dict[<span class="st">'node_ids'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="168">
<pre><code>{'BACS': 0,
 'BARANYA': 1,
 'BEKES': 2,
 'BORSOD': 3,
 'BUDAPEST': 4,
 'CSONGRAD': 5,
 'FEJER': 6,
 'GYOR': 7,
 'HAJDU': 8,
 'HEVES': 9,
 'JASZ': 10,
 'KOMAROM': 11,
 'NOGRAD': 12,
 'PEST': 13,
 'SOMOGY': 14,
 'SZABOLCS': 15,
 'TOLNA': 16,
 'VAS': 17,
 'VESZPREM': 18,
 'ZALA': 19}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="172">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>np.array(data_dict[<span class="st">'FX'</span>]), np.array(data_dict[<span class="st">'FX'</span>]).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="172">
<pre><code>(array([[-1.08135724e-03, -7.11136085e-01, -3.22808515e+00, ...,
          1.09445310e+00, -7.08747750e-01, -1.82280792e+00],
        [ 2.85705967e-02, -5.98430173e-01, -2.29097341e-01, ...,
         -1.59220988e+00, -2.24597623e-01,  7.86330575e-01],
        [ 3.54742090e-01,  1.90511208e-01,  1.61028185e+00, ...,
          1.38183225e-01, -7.08747750e-01, -5.61724314e-01],
        ...,
        [-4.75512620e-01, -1.19952837e+00, -3.89043358e-01, ...,
         -1.00023329e+00, -1.71429032e+00,  4.70746677e-02],
        [-2.08645035e-01,  6.03766218e-01,  1.08216835e-02, ...,
          4.71099041e-02,  2.45684924e+00, -3.44296107e-01],
        [ 1.21464875e+00,  7.16472130e-01,  1.29038982e+00, ...,
          4.56939849e-01,  7.43702632e-01,  1.00375878e+00]]),
 (521, 20))</code></pre>
</div>
</div>
<p>data_dict는 아래와 같이 구성되어 있음</p>
<div class="cell" data-execution_count="177">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>np.array(data_dict[<span class="st">'edges'</span>]).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="177">
<pre><code>(102, 2)</code></pre>
</div>
</div>
<ul>
<li><code>data_dict['edges']</code>: double list, (102,2) // 노드들에 대한 연결정보가 있음</li>
<li><code>data_dict['node_ids']</code>: dict // 20개의 노드에 대한 설명이 있음</li>
<li><code>data_dict['FX']</code>: double list (521,20) // <span class="math inline">\(T=512\)</span>, <span class="math inline">\(N=|{\cal V}| = 20\)</span>에 대한 신호값. 즉 <span class="math inline">\(f(v,t)\)</span> for <span class="math inline">\(v \in {\cal V}\)</span> and <span class="math inline">\(t = 1,2,\dots, T\)</span> 에 대한 값들</li>
</ul>
<div class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a>torch_geometric_temporal.dataset.ChickenpoxDatasetLoader??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span> torch_geometric_temporal<span class="ansi-blue-fg">.</span>dataset<span class="ansi-blue-fg">.</span>ChickenpoxDatasetLoader<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>        
<span class="ansi-green-fg">class</span> ChickenpoxDatasetLoader<span class="ansi-blue-fg">(</span>object<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"""A dataset of county level chicken pox cases in Hungary between 2004</span>
<span class="ansi-blue-fg">    and 2014. We made it public during the development of PyTorch Geometric</span>
<span class="ansi-blue-fg">    Temporal. The underlying graph is static - vertices are counties and</span>
<span class="ansi-blue-fg">    edges are neighbourhoods. Vertex features are lagged weekly counts of the</span>
<span class="ansi-blue-fg">    chickenpox cases (we included 4 lags). The target is the weekly number of</span>
<span class="ansi-blue-fg">    cases for the upcoming week (signed integers). Our dataset consist of more</span>
<span class="ansi-blue-fg">    than 500 snapshots (weeks).</span>
<span class="ansi-blue-fg">    """</span>
    <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>_read_web_data<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _read_web_data<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        url <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">"https://raw.githubusercontent.com/benedekrozemberczki/pytorch_geometric_temporal/master/dataset/chickenpox.json"</span>
        self<span class="ansi-blue-fg">.</span>_dataset <span class="ansi-blue-fg">=</span> json<span class="ansi-blue-fg">.</span>loads<span class="ansi-blue-fg">(</span>urllib<span class="ansi-blue-fg">.</span>request<span class="ansi-blue-fg">.</span>urlopen<span class="ansi-blue-fg">(</span>url<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>read<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _get_edges<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>_edges <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>array<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_dataset<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">"edges"</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>T
    <span class="ansi-green-fg">def</span> _get_edge_weights<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>_edge_weights <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>ones<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_edges<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _get_targets_and_features<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        stacked_target <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>array<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_dataset<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">"FX"</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>features <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>
            stacked_target<span class="ansi-blue-fg">[</span>i <span class="ansi-blue-fg">:</span> i <span class="ansi-blue-fg">+</span> self<span class="ansi-blue-fg">.</span>lags<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>T
            <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>stacked_target<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">-</span> self<span class="ansi-blue-fg">.</span>lags<span class="ansi-blue-fg">)</span>
        <span class="ansi-blue-fg">]</span>
        self<span class="ansi-blue-fg">.</span>targets <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>
            stacked_target<span class="ansi-blue-fg">[</span>i <span class="ansi-blue-fg">+</span> self<span class="ansi-blue-fg">.</span>lags<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>T
            <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>stacked_target<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">-</span> self<span class="ansi-blue-fg">.</span>lags<span class="ansi-blue-fg">)</span>
        <span class="ansi-blue-fg">]</span>
    <span class="ansi-green-fg">def</span> get_dataset<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> lags<span class="ansi-blue-fg">:</span> int <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">4</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> StaticGraphTemporalSignal<span class="ansi-blue-fg">:</span>
        <span class="ansi-blue-fg">"""Returning the Chickenpox Hungary data iterator.</span>
<span class="ansi-blue-fg">        Args types:</span>
<span class="ansi-blue-fg">            * **lags** *(int)* - The number of time lags.</span>
<span class="ansi-blue-fg">        Return types:</span>
<span class="ansi-blue-fg">            * **dataset** *(StaticGraphTemporalSignal)* - The Chickenpox Hungary dataset.</span>
<span class="ansi-blue-fg">        """</span>
        self<span class="ansi-blue-fg">.</span>lags <span class="ansi-blue-fg">=</span> lags
        self<span class="ansi-blue-fg">.</span>_get_edges<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>_get_edge_weights<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>_get_targets_and_features<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        dataset <span class="ansi-blue-fg">=</span> StaticGraphTemporalSignal<span class="ansi-blue-fg">(</span>
            self<span class="ansi-blue-fg">.</span>_edges<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>_edge_weights<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>features<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>targets
        <span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> dataset
<span class="ansi-red-fg">File:</span>           ~/anaconda3/envs/py37/lib/python3.7/site-packages/torch_geometric_temporal/dataset/chickenpox.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     
</pre>
</div>
</div>
</div>
<div class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a>loader <span class="op">=</span> torch_geometric_temporal.dataset.ChickenpoxDatasetLoader()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a>dataset<span class="op">=</span>loader.get_dataset(lags<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a><span class="bu">type</span>(loader._dataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="132">
<pre><code>dict</code></pre>
</div>
</div>
<div class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a>loader._dataset.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre><code>dict_keys(['edges', 'node_ids', 'FX'])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a>np.array(loader._dataset[<span class="st">'FX'</span>]).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="138">
<pre><code>(521, 20)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a>loader._dataset[<span class="st">'node_ids'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="141">
<pre><code>{'BACS': 0,
 'BARANYA': 1,
 'BEKES': 2,
 'BORSOD': 3,
 'BUDAPEST': 4,
 'CSONGRAD': 5,
 'FEJER': 6,
 'GYOR': 7,
 'HAJDU': 8,
 'HEVES': 9,
 'JASZ': 10,
 'KOMAROM': 11,
 'NOGRAD': 12,
 'PEST': 13,
 'SOMOGY': 14,
 'SZABOLCS': 15,
 'TOLNA': 16,
 'VAS': 17,
 'VESZPREM': 18,
 'ZALA': 19}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1"></a><span class="bu">dir</span>(loader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="145">
<pre><code>['__class__',
 '__delattr__',
 '__dict__',
 '__dir__',
 '__doc__',
 '__eq__',
 '__format__',
 '__ge__',
 '__getattribute__',
 '__gt__',
 '__hash__',
 '__init__',
 '__init_subclass__',
 '__le__',
 '__lt__',
 '__module__',
 '__ne__',
 '__new__',
 '__reduce__',
 '__reduce_ex__',
 '__repr__',
 '__setattr__',
 '__sizeof__',
 '__str__',
 '__subclasshook__',
 '__weakref__',
 '_dataset',
 '_get_edge_weights',
 '_get_edges',
 '_get_targets_and_features',
 '_read_web_data',
 'get_dataset']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1"></a><span class="bu">type</span>(loader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="146">
<pre><code>torch_geometric_temporal.dataset.chickenpox.ChickenpoxDatasetLoader</code></pre>
</div>
</div>
<div class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1"></a>torch_geometric_temporal.ChickenpoxDatasetLoader??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span> torch_geometric_temporal<span class="ansi-blue-fg">.</span>ChickenpoxDatasetLoader<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>        
<span class="ansi-green-fg">class</span> ChickenpoxDatasetLoader<span class="ansi-blue-fg">(</span>object<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"""A dataset of county level chicken pox cases in Hungary between 2004</span>
<span class="ansi-blue-fg">    and 2014. We made it public during the development of PyTorch Geometric</span>
<span class="ansi-blue-fg">    Temporal. The underlying graph is static - vertices are counties and</span>
<span class="ansi-blue-fg">    edges are neighbourhoods. Vertex features are lagged weekly counts of the</span>
<span class="ansi-blue-fg">    chickenpox cases (we included 4 lags). The target is the weekly number of</span>
<span class="ansi-blue-fg">    cases for the upcoming week (signed integers). Our dataset consist of more</span>
<span class="ansi-blue-fg">    than 500 snapshots (weeks).</span>
<span class="ansi-blue-fg">    """</span>
    <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>_read_web_data<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _read_web_data<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        url <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">"https://raw.githubusercontent.com/benedekrozemberczki/pytorch_geometric_temporal/master/dataset/chickenpox.json"</span>
        self<span class="ansi-blue-fg">.</span>_dataset <span class="ansi-blue-fg">=</span> json<span class="ansi-blue-fg">.</span>loads<span class="ansi-blue-fg">(</span>urllib<span class="ansi-blue-fg">.</span>request<span class="ansi-blue-fg">.</span>urlopen<span class="ansi-blue-fg">(</span>url<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>read<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _get_edges<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>_edges <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>array<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_dataset<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">"edges"</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>T
    <span class="ansi-green-fg">def</span> _get_edge_weights<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>_edge_weights <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>ones<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_edges<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _get_targets_and_features<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        stacked_target <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>array<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_dataset<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">"FX"</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>features <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>
            stacked_target<span class="ansi-blue-fg">[</span>i <span class="ansi-blue-fg">:</span> i <span class="ansi-blue-fg">+</span> self<span class="ansi-blue-fg">.</span>lags<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>T
            <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>stacked_target<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">-</span> self<span class="ansi-blue-fg">.</span>lags<span class="ansi-blue-fg">)</span>
        <span class="ansi-blue-fg">]</span>
        self<span class="ansi-blue-fg">.</span>targets <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>
            stacked_target<span class="ansi-blue-fg">[</span>i <span class="ansi-blue-fg">+</span> self<span class="ansi-blue-fg">.</span>lags<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>T
            <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>stacked_target<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">-</span> self<span class="ansi-blue-fg">.</span>lags<span class="ansi-blue-fg">)</span>
        <span class="ansi-blue-fg">]</span>
    <span class="ansi-green-fg">def</span> get_dataset<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> lags<span class="ansi-blue-fg">:</span> int <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">4</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> StaticGraphTemporalSignal<span class="ansi-blue-fg">:</span>
        <span class="ansi-blue-fg">"""Returning the Chickenpox Hungary data iterator.</span>
<span class="ansi-blue-fg">        Args types:</span>
<span class="ansi-blue-fg">            * **lags** *(int)* - The number of time lags.</span>
<span class="ansi-blue-fg">        Return types:</span>
<span class="ansi-blue-fg">            * **dataset** *(StaticGraphTemporalSignal)* - The Chickenpox Hungary dataset.</span>
<span class="ansi-blue-fg">        """</span>
        self<span class="ansi-blue-fg">.</span>lags <span class="ansi-blue-fg">=</span> lags
        self<span class="ansi-blue-fg">.</span>_get_edges<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>_get_edge_weights<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>_get_targets_and_features<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        dataset <span class="ansi-blue-fg">=</span> StaticGraphTemporalSignal<span class="ansi-blue-fg">(</span>
            self<span class="ansi-blue-fg">.</span>_edges<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>_edge_weights<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>features<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>targets
        <span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> dataset
<span class="ansi-red-fg">File:</span>           ~/anaconda3/envs/py37/lib/python3.7/site-packages/torch_geometric_temporal/dataset/chickenpox.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     
</pre>
</div>
</div>
</div>
<div class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1"></a>loader._dataset[<span class="st">'edges'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="142">
<pre><code>[[0, 10],
 [0, 6],
 [0, 13],
 [0, 1],
 [0, 0],
 [0, 5],
 [0, 16],
 [1, 0],
 [1, 16],
 [1, 1],
 [1, 14],
 [2, 10],
 [2, 8],
 [2, 2],
 [2, 5],
 [3, 8],
 [3, 15],
 [3, 12],
 [3, 9],
 [3, 10],
 [3, 3],
 [4, 4],
 [4, 13],
 [5, 0],
 [5, 10],
 [5, 2],
 [5, 5],
 [6, 0],
 [6, 16],
 [6, 6],
 [6, 14],
 [6, 13],
 [6, 11],
 [6, 18],
 [7, 7],
 [7, 17],
 [7, 11],
 [7, 18],
 [8, 3],
 [8, 2],
 [8, 15],
 [8, 8],
 [8, 10],
 [9, 9],
 [9, 13],
 [9, 3],
 [9, 12],
 [9, 10],
 [10, 5],
 [10, 9],
 [10, 8],
 [10, 3],
 [10, 10],
 [10, 2],
 [10, 13],
 [10, 0],
 [11, 6],
 [11, 11],
 [11, 7],
 [11, 13],
 [11, 18],
 [12, 3],
 [12, 9],
 [12, 13],
 [12, 12],
 [13, 13],
 [13, 9],
 [13, 6],
 [13, 4],
 [13, 12],
 [13, 0],
 [13, 11],
 [13, 10],
 [14, 18],
 [14, 19],
 [14, 1],
 [14, 14],
 [14, 6],
 [14, 16],
 [15, 3],
 [15, 15],
 [15, 8],
 [16, 16],
 [16, 14],
 [16, 1],
 [16, 0],
 [16, 6],
 [17, 7],
 [17, 19],
 [17, 17],
 [17, 18],
 [18, 14],
 [18, 18],
 [18, 17],
 [18, 7],
 [18, 6],
 [18, 19],
 [18, 11],
 [19, 18],
 [19, 14],
 [19, 19],
 [19, 17]]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1"></a>dataset.edge_index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="128">
<pre><code>array([[ 0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  2,  2,  2,  2,  3,
         3,  3,  3,  3,  3,  4,  4,  5,  5,  5,  5,  6,  6,  6,  6,  6,
         6,  6,  7,  7,  7,  7,  8,  8,  8,  8,  8,  9,  9,  9,  9,  9,
        10, 10, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 12, 12, 12,
        12, 13, 13, 13, 13, 13, 13, 13, 13, 14, 14, 14, 14, 14, 14, 15,
        15, 15, 16, 16, 16, 16, 16, 17, 17, 17, 17, 18, 18, 18, 18, 18,
        18, 18, 19, 19, 19, 19],
       [10,  6, 13,  1,  0,  5, 16,  0, 16,  1, 14, 10,  8,  2,  5,  8,
        15, 12,  9, 10,  3,  4, 13,  0, 10,  2,  5,  0, 16,  6, 14, 13,
        11, 18,  7, 17, 11, 18,  3,  2, 15,  8, 10,  9, 13,  3, 12, 10,
         5,  9,  8,  3, 10,  2, 13,  0,  6, 11,  7, 13, 18,  3,  9, 13,
        12, 13,  9,  6,  4, 12,  0, 11, 10, 18, 19,  1, 14,  6, 16,  3,
        15,  8, 16, 14,  1,  0,  6,  7, 19, 17, 18, 14, 18, 17,  7,  6,
        19, 11, 18, 14, 19, 17]])</code></pre>
</div>
</div>
</section>
</section>
<section id="데이터셋" class="level1">
<h1>데이터셋</h1>
<section id="chickenpoxdatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="chickenpoxdatasetloader">ChickenpoxDatasetLoader</h2>
<p>A dataset of county level chicken pox cases in Hungary between 2004 and 2014. We made it public during the development of PyTorch Geometric Temporal. The underlying graph is static - vertices are counties and edges are neighbourhoods. Vertex features are lagged weekly counts of the chickenpox cases (we included 4 lags). The target is the weekly number of cases for the upcoming week (signed integers). Our dataset consist of more than 500 snapshots (weeks).</p>
<section id="데이터정리" class="level3">
<h3 class="anchored" data-anchor-id="데이터정리">데이터정리</h3>
<ul>
<li><span class="math inline">\(T\)</span> = 519</li>
<li><span class="math inline">\(N\)</span> = 20 # number of nodes</li>
<li><span class="math inline">\(|{\cal E}|\)</span> = 102 # edges</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (1,)</li>
<li>시간에 따라서 Number of nodes가 변하는지? False</li>
<li>시간에 따라서 Number of nodes가 변하는지? False</li>
<li><span class="math inline">\({\bf X}\)</span>: (20,4) (N,4), <span class="math inline">\(f(v,t_0),f(v,t_1),f(v,t_2),f(v,t_3)\)</span></li>
<li><span class="math inline">\({\bf y}\)</span>: (20,) (N,), <span class="math inline">\(f(v,t_4)\)</span></li>
<li>예제코드적용가능여부: Yes</li>
</ul>
<p><code>-</code> Nodes : <code>20</code></p>
<ul>
<li>vertices are counties</li>
</ul>
<p><code>-</code>Edges : <code>102</code></p>
<ul>
<li>edges are neighbourhoods</li>
</ul>
<p><code>-</code> Time : <code>519</code></p>
<ul>
<li>between 2004 and 2014</li>
<li>per weeks</li>
</ul>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1"></a>loader <span class="op">=</span> torch_geometric_temporal.dataset.ChickenpoxDatasetLoader()</span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="co">#dataset = loader.get_dataset(lags=1)</span></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="co">#train_dataset, test_dataset = temporal_signal_split(dataset, train_ratio=0.8)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1"></a><span class="bu">dir</span>(loader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<pre><code>['__class__',
 '__delattr__',
 '__dict__',
 '__dir__',
 '__doc__',
 '__eq__',
 '__format__',
 '__ge__',
 '__getattribute__',
 '__gt__',
 '__hash__',
 '__init__',
 '__init_subclass__',
 '__le__',
 '__lt__',
 '__module__',
 '__ne__',
 '__new__',
 '__reduce__',
 '__reduce_ex__',
 '__repr__',
 '__setattr__',
 '__sizeof__',
 '__str__',
 '__subclasshook__',
 '__weakref__',
 '_dataset',
 '_get_edge_weights',
 '_get_edges',
 '_get_targets_and_features',
 '_read_web_data',
 'get_dataset']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a>loader.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>torch_geometric_temporal.dataset.chickenpox.ChickenpoxDatasetLoader</code></pre>
</div>
</div>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1"></a>dataset[<span class="dv">0</span>].y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>tensor([ 0.0286, -0.5984, -0.2291, -2.2117, -0.9472, -0.7547,  1.7031,  0.5521,
         3.0492,  0.9522, -0.5873, -0.1983, -1.3266,  0.3287, -0.6502,  0.1273,
        -1.7811, -1.5922, -0.2246,  0.7863])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1"></a>t<span class="op">=</span><span class="dv">0</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>xt <span class="op">=</span> dataset[<span class="dv">0</span>].x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>tensor([[-1.0814e-03],
        [-7.1114e-01],
        [-3.2281e+00],
        [ 6.4750e-01],
        [-1.7302e-01],
        [ 3.6345e-01],
        [-3.4174e+00],
        [-1.9641e+00],
        [-2.2133e+00],
        [-3.3141e-01],
        [-1.8380e+00],
        [-3.4669e-01],
        [ 1.4219e+00],
        [-7.7044e-01],
        [-7.8061e-01],
        [-1.0993e+00],
        [ 2.4583e+00],
        [ 1.0945e+00],
        [-7.0875e-01],
        [-1.8228e+00]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1"></a>data[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>[0, Data(x=[20, 1], edge_index=[2, 102], edge_attr=[102], y=[20])]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1"></a>t,data_t <span class="op">=</span> data[<span class="dv">0</span>] <span class="co"># t=0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1"></a>data[<span class="dv">0</span>][<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>Data(x=[20, 1], edge_index=[2, 102], edge_attr=[102], y=[20])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1738">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.<span class="bu">type</span>,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.<span class="bu">type</span>,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.<span class="bu">type</span>,(data[<span class="dv">0</span>][<span class="dv">1</span>]).y.<span class="bu">type</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1738">
<pre><code>(&lt;function Tensor.type&gt;,
 &lt;function Tensor.type&gt;,
 &lt;function Tensor.type&gt;,
 &lt;function Tensor.type&gt;)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1697">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1"></a><span class="bu">max</span>((data[<span class="dv">4</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1697">
<pre><code>tensor(2.1339)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1668">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1669">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">20</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1670">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1671">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1"></a>data[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1671">
<pre><code>[519, Data(x=[20, 1], edge_index=[2, 102], edge_attr=[102], y=[20])]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1672">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1"></a><span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1672">
<pre><code>102</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1673">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb68-2"><a href="#cb68-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">519</span>):</span>
<span id="cb68-3"><a href="#cb68-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])):</span>
<span id="cb68-4"><a href="#cb68-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1674">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1675">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1675">
<pre><code>(20, 61)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1677">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1"></a>nx.draw(G,with_labels<span class="op">=</span><span class="va">True</span>,font_weight<span class="op">=</span><span class="st">'bold'</span>,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">350</span>,font_color<span class="op">=</span><span class="st">'white'</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-45-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1559">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1"></a>np.where(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">10</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1559">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<div class="cell" data-execution_count="216">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span>  ChickenpoxDatasetLoader</span>
<span id="cb75-2"><a href="#cb75-2"></a>loader <span class="op">=</span> ChickenpoxDatasetLoader()</span>
<span id="cb75-3"><a href="#cb75-3"></a></span>
<span id="cb75-4"><a href="#cb75-4"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb75-5"><a href="#cb75-5"></a></span>
<span id="cb75-6"><a href="#cb75-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="21">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1"></a>data<span class="op">=</span>[]</span>
<span id="cb76-2"><a href="#cb76-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb76-3"><a href="#cb76-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>(tensor([-0.0011,  0.0286,  0.3547,  0.2954]), tensor(0.7106))</code></pre>
</div>
</div>
<p><span class="math inline">\(t=0\)</span>에서 <span class="math inline">\(X\)</span>와 <span class="math inline">\(y\)</span>를 정리하면 아래와 같음.</p>
<ul>
<li>X:= <span class="math inline">\(x_0,x_1,x_2,x_3\)</span></li>
<li>y:= <span class="math inline">\(x_4\)</span></li>
</ul>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>tensor([0.0286, 0.3547, 0.2954, 0.7106])</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_1,x_2,x_3,x_4\)</span></li>
<li>y:= <span class="math inline">\(x_5\)</span></li>
</ul>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>tensor([ 0.3547,  0.2954,  0.7106, -0.6831])</code></pre>
</div>
</div>
<ul>
<li>X:=<span class="math inline">\(x_2,x_3,x_4,x_5\)</span></li>
<li>y:=<span class="math inline">\(x_6\)</span></li>
</ul>
<p>하나의 노드에 길이가 <span class="math inline">\(T\)</span>인 시계열이 맵핑되어 있음. (노드는 총 20개)</p>
<p>각 노드마다 아래와 같은 과정으로 예측이 됨</p>
<ul>
<li><span class="math inline">\((x_0,x_1,x_2,x_3) \to (x_4)\)</span></li>
<li><span class="math inline">\((x_1,x_2,x_3,x_4) \to (x_5)\)</span></li>
</ul>
<p><span class="math inline">\(f(v,t), v \in \{v_1,\dots,v_{20}\}, t=1,2,\dots,519\)</span></p>
<p><span class="math display">\[{\bf X}_{t=1} = \begin{bmatrix}
f(v_1,t=1) &amp; f(v_1,t=2) &amp; f(v_1,t=3)&amp;  f(v_1,t=4) \\
f(v_2,t=1) &amp; f(v_2,t=2) &amp; f(v_2,t=3)&amp;  f(v_2,t=4) \\
\dots &amp; \dots  &amp; \dots &amp; \dots  \\
f(v_{20},t=1) &amp; f(v_{20},t=2) &amp; f(v_{20},t=3)&amp;  f(v_{20},t=4)
\end{bmatrix}\]</span></p>
<p><span class="math display">\[{\bf y}_{t=1} = \begin{bmatrix}
f(v_1,t=5) \\
f(v_2,t=5) \\
\dots  \\
f(v_{20},t=5)
\end{bmatrix}\]</span></p>
<section id="learn" class="level4">
<h4 class="anchored" data-anchor-id="learn">Learn</h4>
<div class="cell" data-execution_count="217">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1"></a>model <span class="op">=</span> RecurrentGCN(node_features<span class="op">=</span><span class="dv">4</span>, filters<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb83-2"><a href="#cb83-2"></a></span>
<span id="cb83-3"><a href="#cb83-3"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb83-4"><a href="#cb83-4"></a></span>
<span id="cb83-5"><a href="#cb83-5"></a>model.train()</span>
<span id="cb83-6"><a href="#cb83-6"></a></span>
<span id="cb83-7"><a href="#cb83-7"></a><span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">50</span>)):</span>
<span id="cb83-8"><a href="#cb83-8"></a>    <span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb83-9"><a href="#cb83-9"></a>        y_hat <span class="op">=</span> model(snapshot.x, snapshot.edge_index, snapshot.edge_attr)</span>
<span id="cb83-10"><a href="#cb83-10"></a>        cost <span class="op">=</span> torch.mean((y_hat<span class="op">-</span>snapshot.y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb83-11"><a href="#cb83-11"></a>        cost.backward()</span>
<span id="cb83-12"><a href="#cb83-12"></a>        optimizer.step()</span>
<span id="cb83-13"><a href="#cb83-13"></a>        optimizer.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 50/50 [00:52&lt;00:00,  1.05s/it]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="218">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb85-2"><a href="#cb85-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb85-3"><a href="#cb85-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb85-4"><a href="#cb85-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb85-5"><a href="#cb85-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb85-6"><a href="#cb85-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="219">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="219">
<pre><code>torch.Size([20, 4])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="220">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="220">
<pre><code>torch.Size([2, 102])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="221">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="221">
<pre><code>torch.Size([102])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="222">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="222">
<pre><code>torch.Size([20])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="223">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="223">
<pre><code>torch.Size([20, 4])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li><p>Vertex features are lagged weekly counts of the chickenpox cases (we included 4 lags). y</p></li>
<li><p>The target is the weekly number of cases for the upcoming week</p></li>
</ul>
<div class="cell" data-execution_count="224">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1"></a>_x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="224">
<pre><code>tensor([[-1.0814e-03,  2.8571e-02,  3.5474e-01,  2.9544e-01],
        [-7.1114e-01, -5.9843e-01,  1.9051e-01,  1.0922e+00],
        [-3.2281e+00, -2.2910e-01,  1.6103e+00, -1.5487e+00],
        [ 6.4750e-01, -2.2117e+00, -9.6858e-01,  1.1862e+00],
        [-1.7302e-01, -9.4717e-01,  1.0347e+00, -6.3751e-01],
        [ 3.6345e-01, -7.5468e-01,  2.9768e-01, -1.6273e-01],
        [-3.4174e+00,  1.7031e+00, -1.6434e+00,  1.7434e+00],
        [-1.9641e+00,  5.5208e-01,  1.1811e+00,  6.7002e-01],
        [-2.2133e+00,  3.0492e+00, -2.3839e+00,  1.8545e+00],
        [-3.3141e-01,  9.5218e-01, -3.7281e-01, -8.2971e-02],
        [-1.8380e+00, -5.8728e-01, -3.5514e-02, -7.2298e-02],
        [-3.4669e-01, -1.9827e-01,  3.9540e-01, -2.4774e-01],
        [ 1.4219e+00, -1.3266e+00,  5.2338e-01, -1.6374e-01],
        [-7.7044e-01,  3.2872e-01, -1.0400e+00,  3.4945e-01],
        [-7.8061e-01, -6.5022e-01,  1.4361e+00, -1.2864e-01],
        [-1.0993e+00,  1.2732e-01,  5.3621e-01,  1.9023e-01],
        [ 2.4583e+00, -1.7811e+00,  5.0732e-02, -9.4371e-01],
        [ 1.0945e+00, -1.5922e+00,  1.3818e-01,  1.1855e+00],
        [-7.0875e-01, -2.2460e-01, -7.0875e-01,  1.5630e+00],
        [-1.8228e+00,  7.8633e-01, -5.6172e-01,  1.2647e+00]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="225">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1"></a>_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="225">
<pre><code>tensor([ 0.7106, -0.0725,  2.6099,  1.7870,  0.8024, -0.2614, -0.8370,  1.9674,
        -0.4212,  0.1655,  1.2519,  2.3743,  0.7877,  0.4531, -0.1721, -0.0614,
         1.0452,  0.3203, -1.3791,  0.0036])</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="pedalmedatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="pedalmedatasetloader">PedalMeDatasetLoader</h2>
<p>A dataset of PedalMe Bicycle deliver orders in London between 2020 and 2021. We made it public during the development of PyTorch Geometric Temporal. The underlying graph is static - vertices are localities and edges are spatial_connections. Vertex features are lagged weekly counts of the delivery demands (we included 4 lags). The target is the weekly number of deliveries the upcoming week. Our dataset consist of more than 30 snapshots (weeks).</p>
<p>데이터정리</p>
<ul>
<li>T = 33</li>
<li>V = 지역의 집합</li>
<li>N = 15 # number of nodes</li>
<li>E = 225 # edges</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (1,) # number of deliveries</li>
<li>시간에 따라서 N이 변하는지? False</li>
<li>시간에 따라서 E가 변하는지? False</li>
<li>X: (15,4) (N,4), <span class="math inline">\(f(v,t_0),f(v,t_1),f(v,t_2),f(v,t_3)\)</span></li>
<li>y: (15,) (N,), <span class="math inline">\(f(v,t_4)\)</span></li>
<li>예제코드적용가능여부: Yes</li>
</ul>
<p><code>-</code> Nodes : <code>15</code></p>
<ul>
<li>vertices are localities</li>
</ul>
<p><code>-</code>Edges : <code>225</code></p>
<ul>
<li>edges are spatial_connections</li>
</ul>
<p><code>-</code> Time : <code>33</code></p>
<ul>
<li>between 2020 and 2021</li>
<li>per weeks</li>
</ul>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span>  PedalMeDatasetLoader</span>
<span id="cb100-2"><a href="#cb100-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb100-3"><a href="#cb100-3"></a></span>
<span id="cb100-4"><a href="#cb100-4"></a>loader <span class="op">=</span> PedalMeDatasetLoader()</span>
<span id="cb100-5"><a href="#cb100-5"></a></span>
<span id="cb100-6"><a href="#cb100-6"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb100-7"><a href="#cb100-7"></a></span>
<span id="cb100-8"><a href="#cb100-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1561">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1"></a>data<span class="op">=</span>[]</span>
<span id="cb101-2"><a href="#cb101-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb101-3"><a href="#cb101-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1541">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1541">
<pre><code>33</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1542">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1542">
<pre><code>(torch.Size([15, 1]), torch.Size([2, 225]), torch.Size([225]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1232">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1233">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">15</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1234">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1235">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1"></a>data[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1235">
<pre><code>[33, Data(x=[15, 1], edge_index=[2, 225], edge_attr=[225], y=[15])]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1236">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb111-2"><a href="#cb111-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">33</span>):</span>
<span id="cb111-3"><a href="#cb111-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])):</span>
<span id="cb111-4"><a href="#cb111-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1237">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1238">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1238">
<pre><code>(15, 120)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1239">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1"></a>nx.draw(G,with_labels<span class="op">=</span><span class="va">True</span>,font_weight<span class="op">=</span><span class="st">'bold'</span>,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">350</span>,font_color<span class="op">=</span><span class="st">'white'</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-72-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1562">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1"></a>np.where(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">10</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1562">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<div class="cell" data-execution_count="226">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span>  PedalMeDatasetLoader</span>
<span id="cb118-2"><a href="#cb118-2"></a>loader <span class="op">=</span> PedalMeDatasetLoader()</span>
<span id="cb118-3"><a href="#cb118-3"></a></span>
<span id="cb118-4"><a href="#cb118-4"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb118-5"><a href="#cb118-5"></a></span>
<span id="cb118-6"><a href="#cb118-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="227">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1"></a>data<span class="op">=</span>[]</span>
<span id="cb119-2"><a href="#cb119-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb119-3"><a href="#cb119-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="231">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="231">
<pre><code>(tensor([ 3.0574, -0.0477, -0.3076,  0.2437]), tensor(-0.2710))</code></pre>
</div>
</div>
<p><span class="math inline">\(t=0\)</span>에서 <span class="math inline">\(X\)</span>와 <span class="math inline">\(y\)</span>를 정리하면 아래와 같음.</p>
<ul>
<li>X:= <span class="math inline">\(x_0,x_1,x_2,x_3\)</span></li>
<li>y:= <span class="math inline">\(x_4\)</span></li>
</ul>
<div class="cell" data-execution_count="234">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="234">
<pre><code>(tensor([-0.0477, -0.3076,  0.2437, -0.2710]), tensor(0.2490))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_1,x_2,x_3,x_4\)</span></li>
<li>y:= <span class="math inline">\(x_5\)</span></li>
</ul>
<div class="cell" data-execution_count="236">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">2</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="236">
<pre><code>(tensor([-0.3076,  0.2437, -0.2710,  0.2490]), tensor(-0.0357))</code></pre>
</div>
</div>
<ul>
<li>X:=<span class="math inline">\(x_2,x_3,x_4,x_5\)</span></li>
<li>y:=<span class="math inline">\(x_6\)</span></li>
</ul>
<p>하나의 노드에 길이가 <span class="math inline">\(T\)</span>인 시계열이 맵핑되어 있음. (노드는 총 15개)</p>
<p>각 노드마다 아래와 같은 과정으로 예측이 됨</p>
<ul>
<li><span class="math inline">\((x_0,x_1,x_2,x_3) \to (x_4)\)</span></li>
<li><span class="math inline">\((x_1,x_2,x_3,x_4) \to (x_5)\)</span></li>
</ul>
<p><span class="math inline">\(f(v,t), v \in \{v_1,\dots,v_{15}\}, t=1,2,\dots,33\)</span></p>
<p><span class="math display">\[{\bf X}_{t=1} = \begin{bmatrix}
f(v_1,t=1) &amp; f(v_1,t=2) &amp; f(v_1,t=3)&amp;  f(v_1,t=4) \\
f(v_2,t=1) &amp; f(v_2,t=2) &amp; f(v_2,t=3)&amp;  f(v_2,t=4) \\
\dots &amp; \dots  &amp; \dots &amp; \dots  \\
f(v_{20},t=1) &amp; f(v_{20},t=2) &amp; f(v_{20},t=3)&amp;  f(v_{20},t=4)
\end{bmatrix}\]</span></p>
<p><span class="math display">\[{\bf y}_{t=1} = \begin{bmatrix}
f(v_1,t=5) \\
f(v_2,t=5) \\
\dots  \\
f(v_{20},t=5)
\end{bmatrix}\]</span></p>
<section id="learn-1" class="level4">
<h4 class="anchored" data-anchor-id="learn-1">Learn</h4>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1"></a>model <span class="op">=</span> RecurrentGCN(node_features<span class="op">=</span><span class="dv">4</span>, filters<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb126-2"><a href="#cb126-2"></a></span>
<span id="cb126-3"><a href="#cb126-3"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb126-4"><a href="#cb126-4"></a></span>
<span id="cb126-5"><a href="#cb126-5"></a>model.train()</span>
<span id="cb126-6"><a href="#cb126-6"></a></span>
<span id="cb126-7"><a href="#cb126-7"></a><span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">50</span>)):</span>
<span id="cb126-8"><a href="#cb126-8"></a>    <span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb126-9"><a href="#cb126-9"></a>        y_hat <span class="op">=</span> model(snapshot.x, snapshot.edge_index, snapshot.edge_attr)</span>
<span id="cb126-10"><a href="#cb126-10"></a>        cost <span class="op">=</span> torch.mean((y_hat<span class="op">-</span>snapshot.y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb126-11"><a href="#cb126-11"></a>        cost.backward()</span>
<span id="cb126-12"><a href="#cb126-12"></a>        optimizer.step()</span>
<span id="cb126-13"><a href="#cb126-13"></a>        optimizer.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 50/50 [00:03&lt;00:00, 16.04it/s]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb128-2"><a href="#cb128-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb128-3"><a href="#cb128-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb128-4"><a href="#cb128-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb128-5"><a href="#cb128-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb128-6"><a href="#cb128-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>torch.Size([15, 4])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>torch.Size([2, 225])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>torch.Size([225])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>torch.Size([15])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>torch.Size([15, 4])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li>Vertex features are lagged weekly counts of the delivery demands (we included 4 lags).</li>
<li>주마다 배달 수요의 수가 얼마나 될지 percentage로, t-4시점까지?</li>
</ul>
<p>y</p>
<ul>
<li>The target is the weekly number of deliveries the <code>upcoming</code> week. Our dataset consist of more than 30 snapshots (weeks).</li>
<li>그 다음주에 배달의 수가 몇 퍼센트로 발생할지?</li>
</ul>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1"></a>_x[<span class="dv">0</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>tensor([[ 3.0574, -0.0477, -0.3076,  0.2437],
        [ 3.2126,  0.1240,  0.0764,  0.5582],
        [ 1.9071, -0.8883,  1.5280, -0.7184]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1"></a>_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>tensor([-0.2710,  0.0888,  0.4733,  0.0907, -0.3129,  0.1184,  0.5886, -0.6571,
         0.2647,  0.2338,  0.1720,  0.5720, -0.9568, -0.4138, -0.5271])</code></pre>
</div>
</div>
</section>
</section>
<section id="wikimathsdatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="wikimathsdatasetloader">WikiMathsDatasetLoader</h2>
<p>A dataset of vital mathematics articles from Wikipedia. We made it public during the development of PyTorch Geometric Temporal. The underlying graph is static - vertices are Wikipedia pages and edges are links between them. The graph is directed and weighted. Weights represent the number of links found at the source Wikipedia page linking to the target Wikipedia page. The target is the daily user visits to the Wikipedia pages between March 16th 2019 and March 15th 2021 which results in 731 periods.</p>
<p>데이터정리</p>
<ul>
<li>T = 722</li>
<li>V = 위키피디아 페이지</li>
<li>N = 1068 # number of nodes</li>
<li>E = 27079 # edges</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (1,) # 해당페이지를 유저가 방문한 횟수</li>
<li>시간에 따라서 N이 변하는지? False</li>
<li>시간에 따라서 E가 변하는지? False</li>
<li>X: (1068,8) (N,8), <span class="math inline">\(f(v,t_0),f(v,t_1),f(v,t_2),f(v,t_3),f(v,t_4),f(v,t_5),f(v,t_6),f(v,t_7)\)</span></li>
<li>y: (1068,) (N,), <span class="math inline">\(f(v,t_8)\)</span></li>
<li>예제코드적용가능여부: Yes</li>
</ul>
<p><code>-</code> Nodes : <code>1068</code></p>
<ul>
<li>vertices are Wikipedia pages</li>
</ul>
<p><code>-</code>Edges : <code>27079</code></p>
<ul>
<li>edges are links between them</li>
</ul>
<p><code>-</code> Time : <code>722</code></p>
<ul>
<li>Wikipedia pages between March 16th 2019 and March 15th 2021</li>
<li>per weeks</li>
</ul>
<div class="cell" data-execution_count="1640">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span>  WikiMathsDatasetLoader</span>
<span id="cb143-2"><a href="#cb143-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb143-3"><a href="#cb143-3"></a></span>
<span id="cb143-4"><a href="#cb143-4"></a>loader <span class="op">=</span> WikiMathsDatasetLoader()</span>
<span id="cb143-5"><a href="#cb143-5"></a></span>
<span id="cb143-6"><a href="#cb143-6"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb143-7"><a href="#cb143-7"></a></span>
<span id="cb143-8"><a href="#cb143-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1641">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1"></a>data<span class="op">=</span>[]</span>
<span id="cb144-2"><a href="#cb144-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb144-3"><a href="#cb144-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1642">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1642">
<pre><code>722</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1643">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1643">
<pre><code>(torch.Size([1068, 8]), torch.Size([2, 27079]), torch.Size([27079]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1646">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1"></a>(data[<span class="dv">10</span>][<span class="dv">1</span>]).x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1646">
<pre><code>tensor([[ 0.4972,  0.6838,  0.7211,  ..., -0.8513,  0.1881,  1.3820],
        [ 0.5457,  0.6016,  0.7071,  ..., -0.4599, -0.6089, -0.0626],
        [ 0.6305,  1.1404,  0.8779,  ..., -0.5370,  0.7422,  0.3862],
        ...,
        [ 0.8699,  0.5451,  1.9254,  ..., -0.8351,  0.3828,  0.3828],
        [ 0.2451,  0.9629,  1.0526,  ..., -0.9213,  0.8731, -0.1138],
        [ 0.0200, -0.0871,  0.2342,  ..., -0.4712,  0.0717,  0.2859]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1616">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1617">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">1068</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1618">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1247">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb154-2"><a href="#cb154-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">722</span>):</span>
<span id="cb154-3"><a href="#cb154-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])):</span>
<span id="cb154-4"><a href="#cb154-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1248">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1249">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1249">
<pre><code>(1068, 27079)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1250">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1"></a>nx.draw(G,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">100</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-99-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1565">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1"></a>np.where(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">10</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1565">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1619">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1"></a>np.where(data[<span class="dv">11</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">10</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1619">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1620">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1"></a>np.where(data[<span class="dv">11</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">20</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1620">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<p>https://www.kaggle.com/code/mapologo/loading-wikipedia-math-essentials</p>
<div class="cell" data-execution_count="239">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span>  WikiMathsDatasetLoader</span>
<span id="cb165-2"><a href="#cb165-2"></a>loader <span class="op">=</span> WikiMathsDatasetLoader()</span>
<span id="cb165-3"><a href="#cb165-3"></a></span>
<span id="cb165-4"><a href="#cb165-4"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb165-5"><a href="#cb165-5"></a></span>
<span id="cb165-6"><a href="#cb165-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="240">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1"></a>data<span class="op">=</span>[]</span>
<span id="cb166-2"><a href="#cb166-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb166-3"><a href="#cb166-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="241">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="241">
<pre><code>(tensor([-0.4323, -0.4739,  0.2659,  0.4844,  0.5367,  0.6412,  0.2179, -0.7617]),
 tensor(-0.4067))</code></pre>
</div>
</div>
<p><span class="math inline">\(t=0\)</span>에서 <span class="math inline">\(X\)</span>와 <span class="math inline">\(y\)</span>를 정리하면 아래와 같음.</p>
<ul>
<li>X:= <span class="math inline">\(x_0,x_1,x_2,x_3,,x_4,x_5,x_6,x_7\)</span></li>
<li>y:= <span class="math inline">\(x_9\)</span></li>
</ul>
<div class="cell" data-execution_count="243">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="243">
<pre><code>(tensor([-0.4739,  0.2659,  0.4844,  0.5367,  0.6412,  0.2179, -0.7617, -0.4067]),
 tensor(0.3064))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8\)</span></li>
<li>y:= <span class="math inline">\(x_9\)</span></li>
</ul>
<div class="cell" data-execution_count="245">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">2</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="245">
<pre><code>(tensor([ 0.2659,  0.4844,  0.5367,  0.6412,  0.2179, -0.7617, -0.4067,  0.3064]),
 tensor(0.4972))</code></pre>
</div>
</div>
<ul>
<li>X:=<span class="math inline">\(x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9\)</span></li>
<li>y:=<span class="math inline">\(x_{10}\)</span></li>
</ul>
<p>하나의 노드에 길이가 <span class="math inline">\(T\)</span>인 시계열이 맵핑되어 있음. (노드는 총 1068개)</p>
<p>각 노드마다 아래와 같은 과정으로 예측이 됨</p>
<ul>
<li><span class="math inline">\((x_0,x_1,x_2,x_3,x_4,x_5,x_6,x_7) \to (x_8)\)</span></li>
<li><span class="math inline">\((x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8) \to (x_9)\)</span></li>
</ul>
<p><span class="math inline">\(f(v,t), v \in \{v_1,\dots,v_{1068}\}, t=1,2,\dots,722\)</span></p>
<p><span class="math display">\[{\bf X}_{t=1} = \begin{bmatrix}
f(v_1,t=1) &amp; f(v_1,t=2) &amp; f(v_1,t=3)&amp;  f(v_1,t=4) \\
f(v_2,t=1) &amp; f(v_2,t=2) &amp; f(v_2,t=3)&amp;  f(v_2,t=4) \\
\dots &amp; \dots  &amp; \dots &amp; \dots  \\
f(v_{20},t=1) &amp; f(v_{20},t=2) &amp; f(v_{20},t=3)&amp;  f(v_{20},t=4)
\end{bmatrix}\]</span></p>
<p><span class="math display">\[{\bf y}_{t=1} = \begin{bmatrix}
f(v_1,t=5) \\
f(v_2,t=5) \\
\dots  \\
f(v_{20},t=5)
\end{bmatrix}\]</span></p>
<section id="learn-2" class="level4">
<h4 class="anchored" data-anchor-id="learn-2">Learn</h4>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1"></a>model <span class="op">=</span> RecurrentGCN(node_features<span class="op">=</span><span class="dv">8</span>, filters<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb173-2"><a href="#cb173-2"></a></span>
<span id="cb173-3"><a href="#cb173-3"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb173-4"><a href="#cb173-4"></a></span>
<span id="cb173-5"><a href="#cb173-5"></a>model.train()</span>
<span id="cb173-6"><a href="#cb173-6"></a></span>
<span id="cb173-7"><a href="#cb173-7"></a><span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">50</span>)):</span>
<span id="cb173-8"><a href="#cb173-8"></a>    <span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb173-9"><a href="#cb173-9"></a>        y_hat <span class="op">=</span> model(snapshot.x, snapshot.edge_index, snapshot.edge_attr)</span>
<span id="cb173-10"><a href="#cb173-10"></a>        cost <span class="op">=</span> torch.mean((y_hat<span class="op">-</span>snapshot.y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb173-11"><a href="#cb173-11"></a>        cost.backward()</span>
<span id="cb173-12"><a href="#cb173-12"></a>        optimizer.step()</span>
<span id="cb173-13"><a href="#cb173-13"></a>        optimizer.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 50/50 [09:28&lt;00:00, 11.37s/it]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb175-2"><a href="#cb175-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb175-3"><a href="#cb175-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb175-4"><a href="#cb175-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb175-5"><a href="#cb175-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb175-6"><a href="#cb175-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="168">
<pre><code>torch.Size([1068, 8])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>torch.Size([2, 27079])</code></pre>
</div>
</div>
<p>어떤 페이지에 refer가 되었는지</p>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1"></a>_edge_index[<span class="dv">0</span>][:<span class="dv">5</span>],_edge_index[<span class="dv">1</span>][:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>(tensor([0, 0, 0, 0, 0]), tensor([1, 2, 3, 4, 5]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="116">
<pre><code>torch.Size([27079])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1"></a>_edge_attr[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>tensor([1., 4., 2., 2., 5.])</code></pre>
</div>
</div>
<ul>
<li>Weights represent the number of links found at the source Wikipedia page linking to the target Wikipedia page.</li>
</ul>
<p>가중치는 엣지별 한 페이지에 refer되었는지, 몇 번 되었나 수 나옴</p>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>torch.Size([1068])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>torch.Size([1068, 8])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li>lag 를 몇으로 지정하느냐에 따라 다르게 추출</li>
</ul>
<p>y</p>
<ul>
<li>The target is the daily user visits to the Wikipedia pages between March 16th 2019 and March 15th 2021 which results in 731 periods.</li>
<li>매일 위키피디아 해당 페이지에 몇 명의 유저가 방문하는지!</li>
<li>음수가 왜 나오지..</li>
</ul>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1"></a>_x[<span class="dv">0</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>tensor([[-0.4323, -0.4739,  0.2659,  0.4844,  0.5367,  0.6412,  0.2179, -0.7617],
        [-0.4041, -0.4165, -0.0751,  0.1484,  0.4153,  0.4464, -0.3916, -0.8137],
        [-0.3892,  0.0634,  0.5913,  0.5370,  0.4646,  0.2776, -0.0724, -0.8116]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1"></a>_y[:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="117">
<pre><code>tensor([-0.4067, -0.1620, -0.4043])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1"></a>y_hat[:<span class="dv">3</span>].data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="147">
<pre><code>tensor([[-0.0648],
        [ 0.0314],
        [-1.0724]])</code></pre>
</div>
</div>
</section>
</section>
<section id="windmilloutputlargedatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="windmilloutputlargedatasetloader">WindmillOutputLargeDatasetLoader</h2>
<p>Hourly energy output of windmills from a European country for more than 2 years. Vertices represent 319 windmills and weighted edges describe the strength of relationships. The target variable allows for regression tasks.</p>
<p>데이터정리</p>
<ul>
<li>T = 17470</li>
<li>V = 풍력발전소</li>
<li>N = 319 # number of nodes</li>
<li>E = 101761 = N^2 # edges</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (1,) # Hourly energy output</li>
<li>시간에 따라서 N이 변하는지? False</li>
<li>시간에 따라서 E가 변하는지? False</li>
<li>X: (319,4) (N,4), <span class="math inline">\(f(v,t_0),f(v,t_1),f(v,t_2),f(v,t_3)\)</span></li>
<li>y: (319,) (N,), <span class="math inline">\(f(v,t_4)\)</span></li>
<li>예제코드적용가능여부: Yes</li>
</ul>
<p><code>-</code> Nodes : <code>319</code></p>
<ul>
<li>vertices represent 319 windmills</li>
</ul>
<p><code>-</code>Edges : <code>101761</code></p>
<ul>
<li>weighted edges describe the strength of relationships.</li>
</ul>
<p><code>-</code> Time : <code>17470</code></p>
<ul>
<li>more than 2 years</li>
</ul>
<div class="cell" data-execution_count="1566">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span>  WindmillOutputLargeDatasetLoader</span>
<span id="cb196-2"><a href="#cb196-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb196-3"><a href="#cb196-3"></a></span>
<span id="cb196-4"><a href="#cb196-4"></a>loader <span class="op">=</span> WindmillOutputLargeDatasetLoader()</span>
<span id="cb196-5"><a href="#cb196-5"></a></span>
<span id="cb196-6"><a href="#cb196-6"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb196-7"><a href="#cb196-7"></a></span>
<span id="cb196-8"><a href="#cb196-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1567">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1"></a>data<span class="op">=</span>[]</span>
<span id="cb197-2"><a href="#cb197-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb197-3"><a href="#cb197-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1279">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1279">
<pre><code>17470</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1280">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1280">
<pre><code>(torch.Size([319, 1]), torch.Size([2, 101761]), torch.Size([101761]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1281">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1282">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">319</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1283">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1284">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1"></a>data[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1284">
<pre><code>[17470, Data(x=[319, 1], edge_index=[2, 101761], edge_attr=[101761], y=[319])]</code></pre>
</div>
</div>
<p>time이 너무 많아서 일부만 시각화함!!</p>
<div class="cell" data-execution_count="1285">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb207-2"><a href="#cb207-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</span>
<span id="cb207-3"><a href="#cb207-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])):</span>
<span id="cb207-4"><a href="#cb207-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1286">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1287">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1287">
<pre><code>(319, 51040)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1288">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1"></a>nx.draw(G,with_labels<span class="op">=</span><span class="va">True</span>,font_weight<span class="op">=</span><span class="st">'bold'</span>,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">350</span>,font_color<span class="op">=</span><span class="st">'white'</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-131-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1568">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1"></a>np.where(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">10</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1568">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<div class="cell" data-execution_count="246">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span>  WindmillOutputLargeDatasetLoader</span>
<span id="cb214-2"><a href="#cb214-2"></a>loader <span class="op">=</span> WindmillOutputLargeDatasetLoader()</span>
<span id="cb214-3"><a href="#cb214-3"></a></span>
<span id="cb214-4"><a href="#cb214-4"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb214-5"><a href="#cb214-5"></a></span>
<span id="cb214-6"><a href="#cb214-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="247">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1"></a>data<span class="op">=</span>[]</span>
<span id="cb215-2"><a href="#cb215-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb215-3"><a href="#cb215-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="248">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="248">
<pre><code>(tensor([-0.5711, -0.7560,  2.6278, -0.8674]), tensor(-0.9877))</code></pre>
</div>
</div>
<p><span class="math inline">\(t=0\)</span>에서 <span class="math inline">\(X\)</span>와 <span class="math inline">\(y\)</span>를 정리하면 아래와 같음.</p>
<ul>
<li>X:= <span class="math inline">\(x_0,x_1,x_2,x_3\)</span></li>
<li>y:= <span class="math inline">\(x_4\)</span></li>
</ul>
<div class="cell" data-execution_count="249">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="249">
<pre><code>(tensor([-0.7560,  2.6278, -0.8674, -0.9877]), tensor(-0.8583))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_1,x_2,x_3,x_4\)</span></li>
<li>y:= <span class="math inline">\(x_5\)</span></li>
</ul>
<div class="cell" data-execution_count="250">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">2</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="250">
<pre><code>(tensor([ 2.6278, -0.8674, -0.9877, -0.8583]), tensor(0.4282))</code></pre>
</div>
</div>
<ul>
<li>X:=<span class="math inline">\(x_2,x_3,x_4,x_5\)</span></li>
<li>y:=<span class="math inline">\(x_6\)</span></li>
</ul>
<p>하나의 노드에 길이가 <span class="math inline">\(T\)</span>인 시계열이 맵핑되어 있음. (노드는 총 319개)</p>
<p>각 노드마다 아래와 같은 과정으로 예측이 됨</p>
<ul>
<li><span class="math inline">\((x_0,x_1,x_2,x_3) \to (x_4)\)</span></li>
<li><span class="math inline">\((x_1,x_2,x_3,x_4) \to (x_5)\)</span></li>
</ul>
<p><span class="math inline">\(f(v,t), v \in \{v_1,\dots,v_{319}\}, t=1,2,\dots,17470\)</span></p>
<p><span class="math display">\[{\bf X}_{t=1} = \begin{bmatrix}
f(v_1,t=1) &amp; f(v_1,t=2) &amp; f(v_1,t=3)&amp;  f(v_1,t=4) \\
f(v_2,t=1) &amp; f(v_2,t=2) &amp; f(v_2,t=3)&amp;  f(v_2,t=4) \\
\dots &amp; \dots  &amp; \dots &amp; \dots  \\
f(v_{20},t=1) &amp; f(v_{20},t=2) &amp; f(v_{20},t=3)&amp;  f(v_{20},t=4)
\end{bmatrix}\]</span></p>
<p><span class="math display">\[{\bf y}_{t=1} = \begin{bmatrix}
f(v_1,t=5) \\
f(v_2,t=5) \\
\dots  \\
f(v_{20},t=5)
\end{bmatrix}\]</span></p>
<section id="learn-3" class="level4">
<h4 class="anchored" data-anchor-id="learn-3">Learn</h4>
<div class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1"></a>model <span class="op">=</span> RecurrentGCN(node_features<span class="op">=</span><span class="dv">4</span>, filters<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb222-2"><a href="#cb222-2"></a></span>
<span id="cb222-3"><a href="#cb222-3"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb222-4"><a href="#cb222-4"></a></span>
<span id="cb222-5"><a href="#cb222-5"></a>model.train()</span>
<span id="cb222-6"><a href="#cb222-6"></a></span>
<span id="cb222-7"><a href="#cb222-7"></a><span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">5</span>)):</span>
<span id="cb222-8"><a href="#cb222-8"></a>    <span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb222-9"><a href="#cb222-9"></a>        y_hat <span class="op">=</span> model(snapshot.x, snapshot.edge_index, snapshot.edge_attr)</span>
<span id="cb222-10"><a href="#cb222-10"></a>        cost <span class="op">=</span> torch.mean((y_hat<span class="op">-</span>snapshot.y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb222-11"><a href="#cb222-11"></a>        cost.backward()</span>
<span id="cb222-12"><a href="#cb222-12"></a>        optimizer.step()</span>
<span id="cb222-13"><a href="#cb222-13"></a>        optimizer.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 5/5 [1:06:03&lt;00:00, 792.70s/it]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb224-2"><a href="#cb224-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb224-3"><a href="#cb224-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb224-4"><a href="#cb224-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb224-5"><a href="#cb224-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb224-6"><a href="#cb224-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="147">
<pre><code>torch.Size([319, 4])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="148">
<pre><code>torch.Size([2, 101761])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="149">
<pre><code>torch.Size([101761])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="150">
<pre><code>torch.Size([319])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="151">
<pre><code>torch.Size([319, 4])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li></li>
</ul>
<p>y</p>
<ul>
<li>The target variable allows for regression tasks.</li>
</ul>
<div class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1"></a>_x[<span class="dv">0</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="152">
<pre><code>tensor([[-0.5711, -0.7560,  2.6278, -0.8674],
        [-0.6936, -0.7264,  2.4113, -0.6052],
        [-0.8666, -0.7785,  2.2759, -0.6759]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1"></a>_y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="154">
<pre><code>tensor(-0.9877)</code></pre>
</div>
</div>
</section>
</section>
<section id="windmilloutputmediumdatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="windmilloutputmediumdatasetloader">WindmillOutputMediumDatasetLoader</h2>
<p>Hourly energy output of windmills from a European country for more than 2 years. Vertices represent 26 windmills and weighted edges describe the strength of relationships. The target variable allows for regression tasks.</p>
<p>데이터정리</p>
<ul>
<li>T = 17470</li>
<li>V = 풍력발전소</li>
<li>N = 319 # number of nodes</li>
<li>E = 101761 = N^2 # edges</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (1,) # Hourly energy output</li>
<li>시간에 따라서 N이 변하는지? False</li>
<li>시간에 따라서 E가 변하는지? False</li>
<li>X: (319,4) (N,4), <span class="math inline">\(f(v,t_0),f(v,t_1),f(v,t_2),f(v,t_3)\)</span></li>
<li>y: (319,) (N,), <span class="math inline">\(f(v,t_4)\)</span></li>
<li>예제코드적용가능여부: Yes</li>
</ul>
<p><code>-</code> Nodes : <code>26</code></p>
<ul>
<li>vertices represent 26 windmills</li>
</ul>
<p><code>-</code>Edges : <code>225</code></p>
<ul>
<li>weighted edges describe the strength of relationships</li>
</ul>
<p><code>-</code> Time : <code>676</code></p>
<ul>
<li>more than 2 years</li>
</ul>
<div class="cell" data-execution_count="1569">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span>  WindmillOutputMediumDatasetLoader</span>
<span id="cb239-2"><a href="#cb239-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb239-3"><a href="#cb239-3"></a></span>
<span id="cb239-4"><a href="#cb239-4"></a>loader <span class="op">=</span> WindmillOutputMediumDatasetLoader()</span>
<span id="cb239-5"><a href="#cb239-5"></a></span>
<span id="cb239-6"><a href="#cb239-6"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb239-7"><a href="#cb239-7"></a></span>
<span id="cb239-8"><a href="#cb239-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1570">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1"></a>data<span class="op">=</span>[]</span>
<span id="cb240-2"><a href="#cb240-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb240-3"><a href="#cb240-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1319">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1319">
<pre><code>17470</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1320">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1320">
<pre><code>(torch.Size([26, 1]), torch.Size([2, 676]), torch.Size([676]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1321">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1322">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">26</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1323">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1324">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1"></a>data[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1324">
<pre><code>[17470, Data(x=[26, 1], edge_index=[2, 676], edge_attr=[676], y=[26])]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1325">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb250-2"><a href="#cb250-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">17463</span>):</span>
<span id="cb250-3"><a href="#cb250-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])):</span>
<span id="cb250-4"><a href="#cb250-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1326">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1327">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1327">
<pre><code>(26, 351)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1328">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1"></a>nx.draw(G,with_labels<span class="op">=</span><span class="va">True</span>,font_weight<span class="op">=</span><span class="st">'bold'</span>,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">350</span>,font_color<span class="op">=</span><span class="st">'white'</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-158-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1571">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1"></a>np.where(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">10</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1571">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<div class="cell" data-execution_count="251">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span>  WindmillOutputMediumDatasetLoader</span>
<span id="cb257-2"><a href="#cb257-2"></a>loader <span class="op">=</span> WindmillOutputMediumDatasetLoader()</span>
<span id="cb257-3"><a href="#cb257-3"></a></span>
<span id="cb257-4"><a href="#cb257-4"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb257-5"><a href="#cb257-5"></a></span>
<span id="cb257-6"><a href="#cb257-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="252">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1"></a>data<span class="op">=</span>[]</span>
<span id="cb258-2"><a href="#cb258-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb258-3"><a href="#cb258-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="253">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="253">
<pre><code>(tensor([-0.2170, -0.2055, -0.1587, -0.1930]), tensor(-0.2149))</code></pre>
</div>
</div>
<p><span class="math inline">\(t=0\)</span>에서 <span class="math inline">\(X\)</span>와 <span class="math inline">\(y\)</span>를 정리하면 아래와 같음.</p>
<ul>
<li>X:= <span class="math inline">\(x_0,x_1,x_2,x_3\)</span></li>
<li>y:= <span class="math inline">\(x_4\)</span></li>
</ul>
<div class="cell" data-execution_count="254">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="254">
<pre><code>(tensor([-0.2055, -0.1587, -0.1930, -0.2149]), tensor(-0.2336))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_1,x_2,x_3,x_4\)</span></li>
<li>y:= <span class="math inline">\(x_5\)</span></li>
</ul>
<div class="cell" data-execution_count="255">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">2</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="255">
<pre><code>(tensor([-0.1587, -0.1930, -0.2149, -0.2336]), tensor(-0.1785))</code></pre>
</div>
</div>
<ul>
<li>X:=<span class="math inline">\(x_2,x_3,x_4,x_5\)</span></li>
<li>y:=<span class="math inline">\(x_6\)</span></li>
</ul>
<p>하나의 노드에 길이가 <span class="math inline">\(T\)</span>인 시계열이 맵핑되어 있음. (노드는 총 26개)</p>
<p>각 노드마다 아래와 같은 과정으로 예측이 됨</p>
<ul>
<li><span class="math inline">\((x_0,x_1,x_2,x_3) \to (x_4)\)</span></li>
<li><span class="math inline">\((x_1,x_2,x_3,x_4) \to (x_5)\)</span></li>
</ul>
<p><span class="math inline">\(f(v,t), v \in \{v_1,\dots,v_{26}\}, t=1,2,\dots,177470\)</span></p>
<p><span class="math display">\[{\bf X}_{t=1} = \begin{bmatrix}
f(v_1,t=1) &amp; f(v_1,t=2) &amp; f(v_1,t=3)&amp;  f(v_1,t=4) \\
f(v_2,t=1) &amp; f(v_2,t=2) &amp; f(v_2,t=3)&amp;  f(v_2,t=4) \\
\dots &amp; \dots  &amp; \dots &amp; \dots  \\
f(v_{20},t=1) &amp; f(v_{20},t=2) &amp; f(v_{20},t=3)&amp;  f(v_{20},t=4)
\end{bmatrix}\]</span></p>
<p><span class="math display">\[{\bf y}_{t=1} = \begin{bmatrix}
f(v_1,t=5) \\
f(v_2,t=5) \\
\dots  \\
f(v_{20},t=5)
\end{bmatrix}\]</span></p>
<section id="learn-4" class="level4">
<h4 class="anchored" data-anchor-id="learn-4">Learn</h4>
<div class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1"></a>model <span class="op">=</span> RecurrentGCN(node_features<span class="op">=</span><span class="dv">4</span>, filters<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb265-2"><a href="#cb265-2"></a></span>
<span id="cb265-3"><a href="#cb265-3"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb265-4"><a href="#cb265-4"></a></span>
<span id="cb265-5"><a href="#cb265-5"></a>model.train()</span>
<span id="cb265-6"><a href="#cb265-6"></a></span>
<span id="cb265-7"><a href="#cb265-7"></a><span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">5</span>)):</span>
<span id="cb265-8"><a href="#cb265-8"></a>    <span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb265-9"><a href="#cb265-9"></a>        y_hat <span class="op">=</span> model(snapshot.x, snapshot.edge_index, snapshot.edge_attr)</span>
<span id="cb265-10"><a href="#cb265-10"></a>        cost <span class="op">=</span> torch.mean((y_hat<span class="op">-</span>snapshot.y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb265-11"><a href="#cb265-11"></a>        cost.backward()</span>
<span id="cb265-12"><a href="#cb265-12"></a>        optimizer.step()</span>
<span id="cb265-13"><a href="#cb265-13"></a>        optimizer.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 5/5 [03:23&lt;00:00, 40.73s/it]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb267-2"><a href="#cb267-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb267-3"><a href="#cb267-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb267-4"><a href="#cb267-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb267-5"><a href="#cb267-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb267-6"><a href="#cb267-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="163">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="163">
<pre><code>torch.Size([26, 4])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="164">
<pre><code>torch.Size([2, 676])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="165">
<pre><code>torch.Size([676])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="166">
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="166">
<pre><code>torch.Size([26])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="167">
<pre><code>torch.Size([26, 4])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li></li>
</ul>
<p>y</p>
<ul>
<li>The target variable allows for regression tasks.</li>
</ul>
<div class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1"></a>_x[<span class="dv">0</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="168">
<pre><code>tensor([[-0.2170, -0.2055, -0.1587, -0.1930],
        [-0.1682, -0.2708, -0.1051,  1.1786],
        [ 1.1540, -0.6707, -0.8291, -0.6823]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="169">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1"></a>_y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="169">
<pre><code>tensor(-0.2149)</code></pre>
</div>
</div>
</section>
</section>
<section id="windmilloutputsmalldatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="windmilloutputsmalldatasetloader">WindmillOutputSmallDatasetLoader</h2>
<p>Hourly energy output of windmills from a European country for more than 2 years. Vertices represent 11 windmills and weighted edges describe the strength of relationships. The target variable allows for regression tasks.</p>
<p>데이터정리</p>
<ul>
<li>T = 17470</li>
<li>V = 풍력발전소</li>
<li>N = 319 # number of nodes</li>
<li>E = 101761 = N^2 # edges</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (1,) # Hourly energy output</li>
<li>시간에 따라서 N이 변하는지? False</li>
<li>시간에 따라서 E가 변하는지? False</li>
<li>X: (319,4) (N,4), <span class="math inline">\(f(v,t_0),f(v,t_1),f(v,t_2),f(v,t_3)\)</span></li>
<li>y: (319,) (N,), <span class="math inline">\(f(v,t_4)\)</span></li>
<li>예제코드적용가능여부: Yes</li>
</ul>
<p><code>-</code> Nodes : <code>11</code></p>
<ul>
<li>vertices represent 11 windmills</li>
</ul>
<p><code>-</code>Edges : <code>121</code></p>
<ul>
<li>weighted edges describe the strength of relationships</li>
</ul>
<p><code>-</code> Time : <code>17470</code></p>
<ul>
<li>more than 2 years</li>
</ul>
<div class="cell" data-execution_count="1572">
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> WindmillOutputSmallDatasetLoader</span>
<span id="cb282-2"><a href="#cb282-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb282-3"><a href="#cb282-3"></a></span>
<span id="cb282-4"><a href="#cb282-4"></a>loader <span class="op">=</span> WindmillOutputSmallDatasetLoader()</span>
<span id="cb282-5"><a href="#cb282-5"></a></span>
<span id="cb282-6"><a href="#cb282-6"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb282-7"><a href="#cb282-7"></a></span>
<span id="cb282-8"><a href="#cb282-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1573">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1"></a>data<span class="op">=</span>[]</span>
<span id="cb283-2"><a href="#cb283-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb283-3"><a href="#cb283-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1303">
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1303">
<pre><code>17463</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1304">
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1304">
<pre><code>(torch.Size([11, 8]), torch.Size([2, 121]), torch.Size([121]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1305">
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1"></a>data[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1305">
<pre><code>[17463, Data(x=[11, 8], edge_index=[2, 121], edge_attr=[121], y=[11])]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1306">
<div class="sourceCode cell-code" id="cb290"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1307">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">11</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1308">
<div class="sourceCode cell-code" id="cb292"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1313">
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb293-2"><a href="#cb293-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">17463</span>):</span>
<span id="cb293-3"><a href="#cb293-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])):</span>
<span id="cb293-4"><a href="#cb293-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1314">
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1315">
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1315">
<pre><code>(11, 66)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1316">
<div class="sourceCode cell-code" id="cb297"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb297-1"><a href="#cb297-1"></a>nx.draw(G,with_labels<span class="op">=</span><span class="va">True</span>,font_weight<span class="op">=</span><span class="st">'bold'</span>,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">350</span>,font_color<span class="op">=</span><span class="st">'white'</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-185-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1574">
<div class="sourceCode cell-code" id="cb298"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb298-1"><a href="#cb298-1"></a>np.where(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">10</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1574">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<div class="cell" data-execution_count="256">
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> WindmillOutputSmallDatasetLoader</span>
<span id="cb300-2"><a href="#cb300-2"></a>loader <span class="op">=</span> WindmillOutputSmallDatasetLoader()</span>
<span id="cb300-3"><a href="#cb300-3"></a></span>
<span id="cb300-4"><a href="#cb300-4"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb300-5"><a href="#cb300-5"></a></span>
<span id="cb300-6"><a href="#cb300-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="257">
<div class="sourceCode cell-code" id="cb301"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb301-1"><a href="#cb301-1"></a>data<span class="op">=</span>[]</span>
<span id="cb301-2"><a href="#cb301-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb301-3"><a href="#cb301-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="258">
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb302-1"><a href="#cb302-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="258">
<pre><code>(tensor([ 0.8199, -0.4972,  0.4923, -0.8299]), tensor(-0.6885))</code></pre>
</div>
</div>
<p><span class="math inline">\(t=0\)</span>에서 <span class="math inline">\(X\)</span>와 <span class="math inline">\(y\)</span>를 정리하면 아래와 같음.</p>
<ul>
<li>X:= <span class="math inline">\(x_0,x_1,x_2,x_3\)</span></li>
<li>y:= <span class="math inline">\(x_4\)</span></li>
</ul>
<div class="cell" data-execution_count="260">
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb304-1"><a href="#cb304-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="260">
<pre><code>(tensor([-0.4972,  0.4923, -0.8299, -0.6885]), tensor(0.7092))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_1,x_2,x_3,x_4\)</span></li>
<li>y:= <span class="math inline">\(x_5\)</span></li>
</ul>
<div class="cell" data-execution_count="261">
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb306-1"><a href="#cb306-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">2</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="261">
<pre><code>(tensor([ 0.4923, -0.8299, -0.6885,  0.7092]), tensor(-0.9356))</code></pre>
</div>
</div>
<ul>
<li>X:=<span class="math inline">\(x_2,x_3,x_4,x_5\)</span></li>
<li>y:=<span class="math inline">\(x_6\)</span></li>
</ul>
<p>하나의 노드에 길이가 <span class="math inline">\(T\)</span>인 시계열이 맵핑되어 있음. (노드는 총 11개)</p>
<p>각 노드마다 아래와 같은 과정으로 예측이 됨</p>
<ul>
<li><span class="math inline">\((x_0,x_1,x_2,x_3) \to (x_4)\)</span></li>
<li><span class="math inline">\((x_1,x_2,x_3,x_4) \to (x_5)\)</span></li>
</ul>
<p><span class="math inline">\(f(v,t), v \in \{v_1,\dots,v_{11}\}, t=1,2,\dots,17463\)</span></p>
<p><span class="math display">\[{\bf X}_{t=1} = \begin{bmatrix}
f(v_1,t=1) &amp; f(v_1,t=2) &amp; f(v_1,t=3)&amp;  f(v_1,t=4) \\
f(v_2,t=1) &amp; f(v_2,t=2) &amp; f(v_2,t=3)&amp;  f(v_2,t=4) \\
\dots &amp; \dots  &amp; \dots &amp; \dots  \\
f(v_{20},t=1) &amp; f(v_{20},t=2) &amp; f(v_{20},t=3)&amp;  f(v_{20},t=4)
\end{bmatrix}\]</span></p>
<p><span class="math display">\[{\bf y}_{t=1} = \begin{bmatrix}
f(v_1,t=5) \\
f(v_2,t=5) \\
\dots  \\
f(v_{20},t=5)
\end{bmatrix}\]</span></p>
<section id="learn-5" class="level4">
<h4 class="anchored" data-anchor-id="learn-5">Learn</h4>
<div class="cell" data-execution_count="174">
<div class="sourceCode cell-code" id="cb308"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb308-1"><a href="#cb308-1"></a>model <span class="op">=</span> RecurrentGCN(node_features<span class="op">=</span><span class="dv">4</span>, filters<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb308-2"><a href="#cb308-2"></a></span>
<span id="cb308-3"><a href="#cb308-3"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb308-4"><a href="#cb308-4"></a></span>
<span id="cb308-5"><a href="#cb308-5"></a>model.train()</span>
<span id="cb308-6"><a href="#cb308-6"></a></span>
<span id="cb308-7"><a href="#cb308-7"></a><span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">5</span>)):</span>
<span id="cb308-8"><a href="#cb308-8"></a>    <span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb308-9"><a href="#cb308-9"></a>        y_hat <span class="op">=</span> model(snapshot.x, snapshot.edge_index, snapshot.edge_attr)</span>
<span id="cb308-10"><a href="#cb308-10"></a>        cost <span class="op">=</span> torch.mean((y_hat<span class="op">-</span>snapshot.y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb308-11"><a href="#cb308-11"></a>        cost.backward()</span>
<span id="cb308-12"><a href="#cb308-12"></a>        optimizer.step()</span>
<span id="cb308-13"><a href="#cb308-13"></a>        optimizer.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 5/5 [02:55&lt;00:00, 35.01s/it]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb310-1"><a href="#cb310-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb310-2"><a href="#cb310-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb310-3"><a href="#cb310-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb310-4"><a href="#cb310-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb310-5"><a href="#cb310-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb310-6"><a href="#cb310-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="176">
<div class="sourceCode cell-code" id="cb311"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb311-1"><a href="#cb311-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="176">
<pre><code>torch.Size([11, 4])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="177">
<div class="sourceCode cell-code" id="cb313"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb313-1"><a href="#cb313-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="177">
<pre><code>torch.Size([2, 121])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="178">
<div class="sourceCode cell-code" id="cb315"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb315-1"><a href="#cb315-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="178">
<pre><code>torch.Size([121])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="179">
<div class="sourceCode cell-code" id="cb317"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb317-1"><a href="#cb317-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="179">
<pre><code>torch.Size([11])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="180">
<div class="sourceCode cell-code" id="cb319"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb319-1"><a href="#cb319-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="180">
<pre><code>torch.Size([11, 4])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li></li>
</ul>
<p>y</p>
<ul>
<li>The target variable allows for regression tasks.</li>
</ul>
<div class="cell" data-execution_count="181">
<div class="sourceCode cell-code" id="cb321"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb321-1"><a href="#cb321-1"></a>_x[<span class="dv">0</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="181">
<pre><code>tensor([[ 0.8199, -0.4972,  0.4923, -0.8299],
        [ 1.1377, -0.3742,  0.3668, -0.8333],
        [ 0.9979, -0.5643,  0.4070, -0.8918]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="211">
<div class="sourceCode cell-code" id="cb323"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb323-1"><a href="#cb323-1"></a>_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="211">
<pre><code>tensor([-0.6885, -0.6594, -0.6303, -0.6983, -0.5416, -0.6186, -0.6031, -0.7580,
        -0.6659, -0.5948, -0.5088])</code></pre>
</div>
</div>
</section>
</section>
<section id="metrladatasetloader_real-world-traffic-dataset" class="level2">
<h2 class="anchored" data-anchor-id="metrladatasetloader_real-world-traffic-dataset">METRLADatasetLoader_real world traffic dataset</h2>
<p>A traffic forecasting dataset based on Los Angeles Metropolitan traffic conditions. The dataset contains traffic readings collected from 207 loop detectors on highways in Los Angeles County in aggregated 5 minute intervals for 4 months between March 2012 to June 2012.</p>
<p>데이터정리</p>
<ul>
<li>T = 33</li>
<li>V = 구역</li>
<li>N = 207 # number of nodes</li>
<li>E = 225</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (3,) # Hourly energy output</li>
<li>시간에 따라서 N이 변하는지? False</li>
<li>시간에 따라서 E가 변하는지? False</li>
<li>X: (207,4) (N,2,12), <span class="math inline">\(x_0,x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11},z_0,z_1,z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11}\)</span></li>
<li>y: (207,) (N,), <span class="math inline">\((x_{12})\)</span></li>
<li>예제코드적용가능여부: No</li>
</ul>
<p>https://arxiv.org/pdf/1707.01926.pdf</p>
<p><code>-</code> Nodes : <code>207</code></p>
<ul>
<li>vertices are localities</li>
</ul>
<p><code>-</code>Edges : <code>225</code></p>
<ul>
<li>edges are spatial_connections</li>
</ul>
<p><code>-</code> Time : <code>33</code></p>
<ul>
<li>between 2020 and 2021</li>
<li>per weeks</li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="1575">
<div class="sourceCode cell-code" id="cb325"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb325-1"><a href="#cb325-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> METRLADatasetLoader</span>
<span id="cb325-2"><a href="#cb325-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb325-3"><a href="#cb325-3"></a></span>
<span id="cb325-4"><a href="#cb325-4"></a>loader <span class="op">=</span> METRLADatasetLoader()</span>
<span id="cb325-5"><a href="#cb325-5"></a></span>
<span id="cb325-6"><a href="#cb325-6"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb325-7"><a href="#cb325-7"></a></span>
<span id="cb325-8"><a href="#cb325-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1576">
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1"></a>data<span class="op">=</span>[]</span>
<span id="cb326-2"><a href="#cb326-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb326-3"><a href="#cb326-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1331">
<div class="sourceCode cell-code" id="cb327"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb327-1"><a href="#cb327-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1331">
<pre><code>34248</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1332">
<div class="sourceCode cell-code" id="cb329"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb329-1"><a href="#cb329-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1332">
<pre><code>(torch.Size([207, 2, 12]), torch.Size([2, 1722]), torch.Size([1722]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1334">
<div class="sourceCode cell-code" id="cb331"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb331-1"><a href="#cb331-1"></a>data[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1334">
<pre><code>[34248,
 Data(x=[207, 2, 12], edge_index=[2, 1722], edge_attr=[1722], y=[207, 12])]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1335">
<div class="sourceCode cell-code" id="cb333"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb333-1"><a href="#cb333-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1336">
<div class="sourceCode cell-code" id="cb334"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb334-1"><a href="#cb334-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">20</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1337">
<div class="sourceCode cell-code" id="cb335"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb335-1"><a href="#cb335-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1341">
<div class="sourceCode cell-code" id="cb336"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb336-1"><a href="#cb336-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb336-2"><a href="#cb336-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</span>
<span id="cb336-3"><a href="#cb336-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])):</span>
<span id="cb336-4"><a href="#cb336-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1342">
<div class="sourceCode cell-code" id="cb337"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb337-1"><a href="#cb337-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1343">
<div class="sourceCode cell-code" id="cb338"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb338-1"><a href="#cb338-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1343">
<pre><code>(207, 1520)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1345">
<div class="sourceCode cell-code" id="cb340"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb340-1"><a href="#cb340-1"></a>nx.draw(G,with_labels<span class="op">=</span><span class="va">True</span>,font_weight<span class="op">=</span><span class="st">'bold'</span>,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">350</span>,font_color<span class="op">=</span><span class="st">'white'</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-212-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1577">
<div class="sourceCode cell-code" id="cb341"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb341-1"><a href="#cb341-1"></a>np.where(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">10</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1577">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<p>논문 내용 중</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/bbb8c414-5531-4269-beb9-ac0f9e8901af-1-11ce66b1-dc5e-45b1-9309-a4b44c38de95.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<div class="cell" data-execution_count="262">
<div class="sourceCode cell-code" id="cb343"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb343-1"><a href="#cb343-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> METRLADatasetLoader</span>
<span id="cb343-2"><a href="#cb343-2"></a>loader <span class="op">=</span> METRLADatasetLoader()</span>
<span id="cb343-3"><a href="#cb343-3"></a></span>
<span id="cb343-4"><a href="#cb343-4"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb343-5"><a href="#cb343-5"></a></span>
<span id="cb343-6"><a href="#cb343-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>lags option 없어서 error 뜸</code> : get_dataset() got an unexpected keyword argument ‘lags’</p>
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="263">
<div class="sourceCode cell-code" id="cb344"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb344-1"><a href="#cb344-1"></a>data<span class="op">=</span>[]</span>
<span id="cb344-2"><a href="#cb344-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb344-3"><a href="#cb344-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="264">
<div class="sourceCode cell-code" id="cb345"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb345-1"><a href="#cb345-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="264">
<pre><code>(tensor([[ 0.5332,  0.4486,  0.5146, -2.6522, -2.6522,  0.1847,  0.6383,  0.4961,
           0.7497,  0.4899,  0.5751,  0.4280],
         [-1.7292, -1.7171, -1.7051, -1.6930, -1.6810, -1.6689, -1.6569, -1.6448,
          -1.6328, -1.6207, -1.6087, -1.5966]]),
 tensor([0.3724, 0.2452, 0.4961, 0.6521, 0.1126, 0.5311, 0.5091, 0.4713, 0.4218,
         0.3909, 0.4761, 0.5641]))</code></pre>
</div>
</div>
<p><span class="math inline">\(t=0\)</span>에서 <span class="math inline">\(X,Z\)</span>와 <span class="math inline">\(y\)</span>를 정리하면 아래와 같음.</p>
<ul>
<li>X:= <span class="math inline">\(x_0,x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11}\)</span></li>
<li>Z:= <span class="math inline">\(z_0,z_1,z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11}\)</span></li>
<li>y:= <span class="math inline">\(x_{12}\)</span></li>
</ul>
<div class="cell" data-execution_count="266">
<div class="sourceCode cell-code" id="cb347"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb347-1"><a href="#cb347-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="266">
<pre><code>(tensor([[ 0.4486,  0.5146, -2.6522, -2.6522,  0.1847,  0.6383,  0.4961,  0.7497,
           0.4899,  0.5751,  0.4280,  0.3724],
         [-1.7171, -1.7051, -1.6930, -1.6810, -1.6689, -1.6569, -1.6448, -1.6328,
          -1.6207, -1.6087, -1.5966, -1.5846]]),
 tensor([ 0.2452,  0.4961,  0.6521,  0.1126,  0.5311,  0.5091,  0.4713,  0.4218,
          0.3909,  0.4761,  0.5641, -0.0022]))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11},x_{12}\)</span></li>
<li>Z:= <span class="math inline">\(z_1,z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11},z_{12}\)</span></li>
<li>y:= <span class="math inline">\(x_{13}\)</span></li>
</ul>
<div class="cell" data-execution_count="267">
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb349-1"><a href="#cb349-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">2</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="267">
<pre><code>(tensor([[ 0.5146, -2.6522, -2.6522,  0.1847,  0.6383,  0.4961,  0.7497,  0.4899,
           0.5751,  0.4280,  0.3724,  0.2452],
         [-1.7051, -1.6930, -1.6810, -1.6689, -1.6569, -1.6448, -1.6328, -1.6207,
          -1.6087, -1.5966, -1.5846, -1.5725]]),
 tensor([ 0.4961,  0.6521,  0.1126,  0.5311,  0.5091,  0.4713,  0.4218,  0.3909,
          0.4761,  0.5641, -0.0022,  0.4218]))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11},x_{12},x_{13}\)</span></li>
<li>Z:= <span class="math inline">\(z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11},z_{12},z_{13}\)</span></li>
<li>y:= <span class="math inline">\(x_{14}\)</span></li>
</ul>
<p>하나의 노드에 길이가 <span class="math inline">\(T\)</span>인 시계열이 맵핑되어 있음. (노드는 총 207개)</p>
<p>각 노드마다 아래와 같은 과정으로 예측이 됨</p>
<ul>
<li><span class="math inline">\(x_0,x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11},z_0,z_1,z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11} \to (x_{12})\)</span></li>
<li><span class="math inline">\(x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11},x_{12},z_1,z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11},z_{12} \to (x_{13})\)</span></li>
</ul>
<p><span class="math inline">\(f(v,t), v \in \{v_1,\dots,v_{207}\}, t=1,2,\dots,34248\)</span></p>
<p><span class="math display">\[{\bf X}_{t=1} = \begin{bmatrix}
f(v_1,t=1) &amp; f(v_1,t=2) &amp; f(v_1,t=3)&amp;  f(v_1,t=4) \\
f(v_2,t=1) &amp; f(v_2,t=2) &amp; f(v_2,t=3)&amp;  f(v_2,t=4) \\
\dots &amp; \dots  &amp; \dots &amp; \dots  \\
f(v_{20},t=1) &amp; f(v_{20},t=2) &amp; f(v_{20},t=3)&amp;  f(v_{20},t=4)
\end{bmatrix}\]</span></p>
<p><span class="math display">\[{\bf y}_{t=1} = \begin{bmatrix}
f(v_1,t=5) \\
f(v_2,t=5) \\
\dots  \\
f(v_{20},t=5)
\end{bmatrix}\]</span></p>
<section id="learn-6" class="level4">
<h4 class="anchored" data-anchor-id="learn-6">Learn</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb351"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb351-1"><a href="#cb351-1"></a>model <span class="op">=</span> RecurrentGCN(node_features<span class="op">=</span><span class="dv">1</span>, filters<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb351-2"><a href="#cb351-2"></a></span>
<span id="cb351-3"><a href="#cb351-3"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb351-4"><a href="#cb351-4"></a></span>
<span id="cb351-5"><a href="#cb351-5"></a>model.train()</span>
<span id="cb351-6"><a href="#cb351-6"></a></span>
<span id="cb351-7"><a href="#cb351-7"></a><span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">50</span>)):</span>
<span id="cb351-8"><a href="#cb351-8"></a>    <span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb351-9"><a href="#cb351-9"></a>        y_hat <span class="op">=</span> model(snapshot.x, snapshot.edge_index, snapshot.edge_attr)</span>
<span id="cb351-10"><a href="#cb351-10"></a>        cost <span class="op">=</span> torch.mean((y_hat<span class="op">-</span>snapshot.y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb351-11"><a href="#cb351-11"></a>        cost.backward()</span>
<span id="cb351-12"><a href="#cb351-12"></a>        optimizer.step()</span>
<span id="cb351-13"><a href="#cb351-13"></a>        optimizer.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb352"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb352-1"><a href="#cb352-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb352-2"><a href="#cb352-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb352-3"><a href="#cb352-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb352-4"><a href="#cb352-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb352-5"><a href="#cb352-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb352-6"><a href="#cb352-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>torch.Size([207, 2, 12])</code></pre>
</div>
</div>
<ul>
<li>node 207개, traffic sensor 2개</li>
</ul>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb355"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb355-1"><a href="#cb355-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>torch.Size([2, 1722])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb357"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb357-1"><a href="#cb357-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>torch.Size([1722])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb359"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb359-1"><a href="#cb359-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>torch.Size([207, 12])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb361"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb361-1"><a href="#cb361-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>torch.Size([207, 2, 12])</code></pre>
</div>
</div>
<p>y</p>
<ul>
<li>traffic speed</li>
</ul>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb363"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb363-1"><a href="#cb363-1"></a>_x[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>tensor([[ 0.5332,  0.4486,  0.5146, -2.6522, -2.6522,  0.1847,  0.6383,  0.4961,
          0.7497,  0.4899,  0.5751,  0.4280],
        [-1.7292, -1.7171, -1.7051, -1.6930, -1.6810, -1.6689, -1.6569, -1.6448,
         -1.6328, -1.6207, -1.6087, -1.5966]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb365-1"><a href="#cb365-1"></a>_y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>tensor([0.3724, 0.2452, 0.4961, 0.6521, 0.1126, 0.5311, 0.5091, 0.4713, 0.4218,
        0.3909, 0.4761, 0.5641])</code></pre>
</div>
</div>
</section>
</section>
<section id="pemsbaydatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="pemsbaydatasetloader">PemsBayDatasetLoader</h2>
<p>https://onlinelibrary.wiley.com/doi/pdf/10.1111/tgis.12644</p>
<p>A traffic forecasting dataset as described in Diffusion Convolution Layer Paper.</p>
<p>This traffic dataset is collected by California Transportation Agencies (CalTrans) Performance Measurement System (PeMS). It is represented by a network of 325 traffic sensors in the Bay Area with 6 months of traffic readings ranging from Jan 1st 2017 to May 31th 2017 in 5 minute intervals.</p>
<p>데이터정리</p>
<ul>
<li>T = 17470</li>
<li>V = 풍력발전소</li>
<li>N = 325 # number of nodes</li>
<li>E = 101761 = N^2 # edges</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (1,) # Hourly energy output</li>
<li>시간에 따라서 N이 변하는지? False</li>
<li>시간에 따라서 E가 변하는지? False</li>
<li>X: (325,2,12) (N,2,12),
<ul>
<li><span class="math inline">\(x_0,x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11}\)</span></li>
<li><span class="math inline">\(z_0,z_1,z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11}\)</span></li>
</ul></li>
<li>y: (325,) (N,2,12),
<ul>
<li><span class="math inline">\(x_{13},x_{14},x_{15},x_{16},x_{17},x_{18},x_{19},x_{20},x_{21},x_{22},x_{23},x_{24}\)</span></li>
<li><span class="math inline">\(z_{13},z_{14},z_{15},z_{16},z_{17},z_{18},z_{19},z_{20},z_{21},z_{22},z_{23},z_{24}\)</span></li>
</ul></li>
<li>예제코드적용가능여부: No</li>
</ul>
<p><code>-</code> Nodes : <code>325</code></p>
<ul>
<li>vertices are sensors</li>
</ul>
<p><code>-</code>Edges : <code>2694</code></p>
<ul>
<li>weighted edges are between seonsor paris measured by the road nretwork distance</li>
</ul>
<p><code>-</code> Time : <code>52081</code></p>
<ul>
<li>6 months of traffic readings ranging from Jan 1st 2017 to May 31th 2017 in 5 minute intervals</li>
</ul>
<div class="cell" data-execution_count="1578">
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb367-1"><a href="#cb367-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> PemsBayDatasetLoader</span>
<span id="cb367-2"><a href="#cb367-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb367-3"><a href="#cb367-3"></a></span>
<span id="cb367-4"><a href="#cb367-4"></a>loader <span class="op">=</span> PemsBayDatasetLoader()</span>
<span id="cb367-5"><a href="#cb367-5"></a></span>
<span id="cb367-6"><a href="#cb367-6"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb367-7"><a href="#cb367-7"></a></span>
<span id="cb367-8"><a href="#cb367-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1579">
<div class="sourceCode cell-code" id="cb368"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb368-1"><a href="#cb368-1"></a>data<span class="op">=</span>[]</span>
<span id="cb368-2"><a href="#cb368-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb368-3"><a href="#cb368-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1348">
<div class="sourceCode cell-code" id="cb369"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb369-1"><a href="#cb369-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1348">
<pre><code>52081</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1349">
<div class="sourceCode cell-code" id="cb371"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb371-1"><a href="#cb371-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1349">
<pre><code>(torch.Size([325, 2, 12]), torch.Size([2, 2694]), torch.Size([2694]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1350">
<div class="sourceCode cell-code" id="cb373"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb373-1"><a href="#cb373-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1351">
<div class="sourceCode cell-code" id="cb374"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb374-1"><a href="#cb374-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">325</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1352">
<div class="sourceCode cell-code" id="cb375"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb375-1"><a href="#cb375-1"></a>data[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1352">
<pre><code>[52081,
 Data(x=[325, 2, 12], edge_index=[2, 2694], edge_attr=[2694], y=[325, 2, 12])]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1353">
<div class="sourceCode cell-code" id="cb377"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb377-1"><a href="#cb377-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1354">
<div class="sourceCode cell-code" id="cb378"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb378-1"><a href="#cb378-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb378-2"><a href="#cb378-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</span>
<span id="cb378-3"><a href="#cb378-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])):</span>
<span id="cb378-4"><a href="#cb378-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1355">
<div class="sourceCode cell-code" id="cb379"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb379-1"><a href="#cb379-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1356">
<div class="sourceCode cell-code" id="cb380"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb380-1"><a href="#cb380-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1356">
<pre><code>(325, 2404)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1363">
<div class="sourceCode cell-code" id="cb382"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb382-1"><a href="#cb382-1"></a>nx.draw(G,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">50</span>,font_color<span class="op">=</span><span class="st">'white'</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-239-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1580">
<div class="sourceCode cell-code" id="cb383"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb383-1"><a href="#cb383-1"></a>np.where(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">10</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1580">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<div class="cell" data-execution_count="268">
<div class="sourceCode cell-code" id="cb385"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb385-1"><a href="#cb385-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> PemsBayDatasetLoader</span>
<span id="cb385-2"><a href="#cb385-2"></a>loader <span class="op">=</span> PemsBayDatasetLoader()</span>
<span id="cb385-3"><a href="#cb385-3"></a></span>
<span id="cb385-4"><a href="#cb385-4"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb385-5"><a href="#cb385-5"></a></span>
<span id="cb385-6"><a href="#cb385-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="269">
<div class="sourceCode cell-code" id="cb386"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb386-1"><a href="#cb386-1"></a>data<span class="op">=</span>[]</span>
<span id="cb386-2"><a href="#cb386-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb386-3"><a href="#cb386-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="270">
<div class="sourceCode cell-code" id="cb387"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb387-1"><a href="#cb387-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="270">
<pre><code>(tensor([[ 0.9821,  0.9928,  1.0251,  1.0574,  1.0466,  1.0681,  0.9821,  1.0251,
           1.0143,  0.9928,  0.9498,  0.9821],
         [-1.6127, -1.6005, -1.5883, -1.5762, -1.5640, -1.5518, -1.5397, -1.5275,
          -1.5153, -1.5032, -1.4910, -1.4788]]),
 tensor([[ 1.0143,  0.9821,  0.9821,  1.0036,  1.0143,  0.9605,  0.9498,  1.0251,
           0.9928,  0.9928,  0.9498,  0.9928],
         [-1.4667, -1.4545, -1.4423, -1.4302, -1.4180, -1.4058, -1.3937, -1.3815,
          -1.3694, -1.3572, -1.3450, -1.3329]]))</code></pre>
</div>
</div>
<p><span class="math inline">\(t=0\)</span>에서 <span class="math inline">\(X,Z\)</span>와 <span class="math inline">\(y,s\)</span>를 정리하면 아래와 같음.</p>
<ul>
<li>X:= <span class="math inline">\(x_0,x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11}\)</span></li>
<li>Z:= <span class="math inline">\(z_0,z_1,z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11}\)</span></li>
<li>y:= <span class="math inline">\(x_{12},x_{13},x_{14},x_{15},x_{16},x_{17},x_{18},x_{19},x_{20},x_{21},x_{22},x_{23}\)</span></li>
<li>s:= <span class="math inline">\(z_{12},z_{13},z_{14},z_{15},z_{16},z_{17},z_{18},z_{19},z_{20},z_{21},z_{22},z_{23}\)</span></li>
</ul>
<div class="cell" data-execution_count="272">
<div class="sourceCode cell-code" id="cb389"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb389-1"><a href="#cb389-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="272">
<pre><code>(tensor([[ 0.9928,  1.0251,  1.0574,  1.0466,  1.0681,  0.9821,  1.0251,  1.0143,
           0.9928,  0.9498,  0.9821,  1.0143],
         [-1.6005, -1.5883, -1.5762, -1.5640, -1.5518, -1.5397, -1.5275, -1.5153,
          -1.5032, -1.4910, -1.4788, -1.4667]]),
 tensor([[ 0.9821,  0.9821,  1.0036,  1.0143,  0.9605,  0.9498,  1.0251,  0.9928,
           0.9928,  0.9498,  0.9928,  0.9821],
         [-1.4545, -1.4423, -1.4302, -1.4180, -1.4058, -1.3937, -1.3815, -1.3694,
          -1.3572, -1.3450, -1.3329, -1.3207]]))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11},x_{12}\)</span></li>
<li>Z:= <span class="math inline">\(z_1,z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11},z_{12}\)</span></li>
<li>y:= <span class="math inline">\(x_{13},x_{14},x_{15},x_{16},x_{17},x_{18},x_{19},x_{20},x_{21},x_{22},x_{23},x_{24}\)</span></li>
<li>s:= <span class="math inline">\(z_{13},z_{14},z_{15},z_{16},z_{17},z_{18},z_{19},z_{20},z_{21},z_{22},z_{23},z_{24}\)</span></li>
</ul>
<div class="cell" data-execution_count="273">
<div class="sourceCode cell-code" id="cb391"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb391-1"><a href="#cb391-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">2</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="273">
<pre><code>(tensor([[ 1.0251,  1.0574,  1.0466,  1.0681,  0.9821,  1.0251,  1.0143,  0.9928,
           0.9498,  0.9821,  1.0143,  0.9821],
         [-1.5883, -1.5762, -1.5640, -1.5518, -1.5397, -1.5275, -1.5153, -1.5032,
          -1.4910, -1.4788, -1.4667, -1.4545]]),
 tensor([[ 0.9821,  1.0036,  1.0143,  0.9605,  0.9498,  1.0251,  0.9928,  0.9928,
           0.9498,  0.9928,  0.9821,  1.0143],
         [-1.4423, -1.4302, -1.4180, -1.4058, -1.3937, -1.3815, -1.3694, -1.3572,
          -1.3450, -1.3329, -1.3207, -1.3085]]))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11},x_{12},x_{13}\)</span></li>
<li>Z:= <span class="math inline">\(z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11},z_{12},z_{13}\)</span></li>
<li>y:= <span class="math inline">\(x_{14},x_{15},x_{16},x_{17},x_{18},x_{19},x_{20},x_{21},x_{22},x_{23},x_{24},x_{25}\)</span></li>
<li>s:= <span class="math inline">\(z_{14},z_{15},z_{16},z_{17},z_{18},z_{19},z_{20},z_{21},z_{22},z_{23},z_{24},z_{25}\)</span></li>
</ul>
<p>하나의 노드에 길이가 <span class="math inline">\(T\)</span>인 시계열이 맵핑되어 있음. (노드는 총 325개)</p>
<p>각 노드마다 아래와 같은 과정으로 예측이 됨</p>
<ul>
<li><span class="math inline">\(x_0,x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11} \to x_{12},x_{13},x_{14},x_{15},x_{16},x_{17},x_{18},x_{19},x_{20},x_{21},x_{22},x_{23}\)</span></li>
<li><span class="math inline">\(z_0,z_1,z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11} \to z_{12},z_{13},z_{14},z_{15},z_{16},z_{17},z_{18},z_{19},z_{20},z_{21},z_{22},z_{23}\)</span></li>
<li><span class="math inline">\(x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10},x_{11},x_{12} \to x_{13},x_{14},x_{15},x_{16},x_{17},x_{18},x_{19},x_{20},x_{21},x_{22},x_{23},x_{24}\)</span></li>
<li><span class="math inline">\(z_1,z_2,z_3,z_4,z_5,z_6,z_7,z_8,z_9,z_{10},z_{11},z_{12} \to z_{13},z_{14},z_{15},z_{16},z_{17},z_{18},z_{19},z_{20},z_{21},z_{22},z_{23},z_{24}\)</span></li>
</ul>
<p><span class="math inline">\(f(v,t), v \in \{v_1,\dots,v_{325}\}, t=1,2,\dots,52081\)</span></p>
<p><span class="math display">\[{\bf X}_{t=1} = \begin{bmatrix}
f(v_1,t=1) &amp; f(v_1,t=2) &amp; f(v_1,t=3)&amp;  f(v_1,t=4) \\
f(v_2,t=1) &amp; f(v_2,t=2) &amp; f(v_2,t=3)&amp;  f(v_2,t=4) \\
\dots &amp; \dots  &amp; \dots &amp; \dots  \\
f(v_{20},t=1) &amp; f(v_{20},t=2) &amp; f(v_{20},t=3)&amp;  f(v_{20},t=4)
\end{bmatrix}\]</span></p>
<p><span class="math display">\[{\bf y}_{t=1} = \begin{bmatrix}
f(v_1,t=5) \\
f(v_2,t=5) \\
\dots  \\
f(v_{20},t=5)
\end{bmatrix}\]</span></p>
<section id="learn-7" class="level4">
<h4 class="anchored" data-anchor-id="learn-7">Learn</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb393"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb393-1"><a href="#cb393-1"></a>model <span class="op">=</span> RecurrentGCN(node_features<span class="op">=</span><span class="dv">4</span>, filters<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb393-2"><a href="#cb393-2"></a></span>
<span id="cb393-3"><a href="#cb393-3"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb393-4"><a href="#cb393-4"></a></span>
<span id="cb393-5"><a href="#cb393-5"></a>model.train()</span>
<span id="cb393-6"><a href="#cb393-6"></a></span>
<span id="cb393-7"><a href="#cb393-7"></a><span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">50</span>)):</span>
<span id="cb393-8"><a href="#cb393-8"></a>    <span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb393-9"><a href="#cb393-9"></a>        y_hat <span class="op">=</span> model(snapshot.x, snapshot.edge_index, snapshot.edge_attr)</span>
<span id="cb393-10"><a href="#cb393-10"></a>        cost <span class="op">=</span> torch.mean((y_hat<span class="op">-</span>snapshot.y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb393-11"><a href="#cb393-11"></a>        cost.backward()</span>
<span id="cb393-12"><a href="#cb393-12"></a>        optimizer.step()</span>
<span id="cb393-13"><a href="#cb393-13"></a>        optimizer.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb394"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb394-1"><a href="#cb394-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb394-2"><a href="#cb394-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb394-3"><a href="#cb394-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb394-4"><a href="#cb394-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb394-5"><a href="#cb394-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb394-6"><a href="#cb394-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb395"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb395-1"><a href="#cb395-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>torch.Size([325, 2, 12])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb397"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb397-1"><a href="#cb397-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>torch.Size([2, 2694])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb399"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb399-1"><a href="#cb399-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>torch.Size([2694])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb401"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb401-1"><a href="#cb401-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>torch.Size([325, 2, 12])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb403"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb403-1"><a href="#cb403-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>torch.Size([325, 2, 12])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li>.!</li>
</ul>
<p>y</p>
<ul>
<li>capturing temporal dependencies..?</li>
</ul>
<p>edges connect sensors</p>
<p>For instance, the traffic conditions on one road on Wednesday at 3:00 p.m. are similar to the traffic conditions on Thursday at the same time.</p>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb405"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb405-1"><a href="#cb405-1"></a>_x[<span class="dv">0</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>tensor([[[ 0.9821,  0.9928,  1.0251,  1.0574,  1.0466,  1.0681,  0.9821,
           1.0251,  1.0143,  0.9928,  0.9498,  0.9821],
         [-1.6127, -1.6005, -1.5883, -1.5762, -1.5640, -1.5518, -1.5397,
          -1.5275, -1.5153, -1.5032, -1.4910, -1.4788]],

        [[ 0.6054,  0.5839,  0.6592,  0.6269,  0.6808,  0.6377,  0.6700,
           0.6054,  0.6162,  0.6162,  0.5839,  0.5947],
         [-1.6127, -1.6005, -1.5883, -1.5762, -1.5640, -1.5518, -1.5397,
          -1.5275, -1.5153, -1.5032, -1.4910, -1.4788]],

        [[ 0.9390,  0.9175,  0.8960,  0.9175,  0.9067,  0.9175,  0.9175,
           0.8852,  0.9283,  0.8960,  0.9067,  0.8960],
         [-1.6127, -1.6005, -1.5883, -1.5762, -1.5640, -1.5518, -1.5397,
          -1.5275, -1.5153, -1.5032, -1.4910, -1.4788]]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb407"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb407-1"><a href="#cb407-1"></a>_y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>tensor([[ 1.0143,  0.9821,  0.9821,  1.0036,  1.0143,  0.9605,  0.9498,  1.0251,
          0.9928,  0.9928,  0.9498,  0.9928],
        [-1.4667, -1.4545, -1.4423, -1.4302, -1.4180, -1.4058, -1.3937, -1.3815,
         -1.3694, -1.3572, -1.3450, -1.3329]])</code></pre>
</div>
</div>
</section>
</section>
<section id="englandcoviddatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="englandcoviddatasetloader">EnglandCovidDatasetLoader</h2>
<p>A dataset of mobility and history of reported cases of COVID-19 in England NUTS3 regions, from 3 March to 12 of May. The dataset is segmented in days and the graph is directed and weighted. The graph indicates how many people moved from one region to the other each day, based on Facebook Data For Good disease prevention maps. The node features correspond to the number of COVID-19 cases in the region in the past window days. The task is to predict the number of cases in each node after 1 day.</p>
<p>https://arxiv.org/pdf/2009.08388.pdf</p>
<p>데이터정리</p>
<ul>
<li>T = 52</li>
<li>V = 지역</li>
<li>N = 129 # number of nodes</li>
<li>E = 2158</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (1,) # 코로나확진자수</li>
<li>시간에 따라서 Number of nodes가 변하는지? False</li>
<li>시간에 따라서 Number of nodes가 변하는지? False</li>
<li>X: (20,4) (N,4), <span class="math inline">\(f(v,t_0),f(v,t_1),f(v,t_2),f(v,t_3)\)</span></li>
<li>y: (20,) (N,), <span class="math inline">\(f(v,t_4)\)</span></li>
<li>예제코드적용가능여부: Yes</li>
</ul>
<p><code>-</code> Nodes : <code>129</code></p>
<ul>
<li>vertices are correspond to the number of COVID-19 cases in the region in the past window days.</li>
</ul>
<p><code>-</code>Edges : <code>2158</code></p>
<ul>
<li>the spatial edges capture county-to-county movement at a specific date, and a county is connected to a number of past instances of itself with temporal edges.</li>
</ul>
<p><code>-</code> Time : <code>52</code></p>
<ul>
<li>from 3 March to 12 of May</li>
</ul>
<div class="cell" data-execution_count="1581">
<div class="sourceCode cell-code" id="cb409"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb409-1"><a href="#cb409-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> EnglandCovidDatasetLoader</span>
<span id="cb409-2"><a href="#cb409-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb409-3"><a href="#cb409-3"></a></span>
<span id="cb409-4"><a href="#cb409-4"></a>loader <span class="op">=</span> EnglandCovidDatasetLoader()</span>
<span id="cb409-5"><a href="#cb409-5"></a></span>
<span id="cb409-6"><a href="#cb409-6"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb409-7"><a href="#cb409-7"></a></span>
<span id="cb409-8"><a href="#cb409-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1582">
<div class="sourceCode cell-code" id="cb410"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb410-1"><a href="#cb410-1"></a>data<span class="op">=</span>[]</span>
<span id="cb410-2"><a href="#cb410-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb410-3"><a href="#cb410-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1366">
<div class="sourceCode cell-code" id="cb411"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb411-1"><a href="#cb411-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1377">
<pre><code>52</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1367">
<div class="sourceCode cell-code" id="cb413"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb413-1"><a href="#cb413-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1378">
<pre><code>(torch.Size([129, 8]), torch.Size([2, 2158]), torch.Size([2158]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1368">
<div class="sourceCode cell-code" id="cb415"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb415-1"><a href="#cb415-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1369">
<div class="sourceCode cell-code" id="cb416"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb416-1"><a href="#cb416-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">129</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1370">
<div class="sourceCode cell-code" id="cb417"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb417-1"><a href="#cb417-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1371">
<div class="sourceCode cell-code" id="cb418"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb418-1"><a href="#cb418-1"></a>data[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1382">
<pre><code>[52, Data(x=[129, 8], edge_index=[2, 1424], edge_attr=[1424], y=[129])]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1387">
<div class="sourceCode cell-code" id="cb420"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb420-1"><a href="#cb420-1"></a><span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1387">
<pre><code>2158</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1392">
<div class="sourceCode cell-code" id="cb422"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb422-1"><a href="#cb422-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb422-2"><a href="#cb422-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">52</span>):</span>
<span id="cb422-3"><a href="#cb422-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb422-4"><a href="#cb422-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1393">
<div class="sourceCode cell-code" id="cb423"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb423-1"><a href="#cb423-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1394">
<div class="sourceCode cell-code" id="cb424"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb424-1"><a href="#cb424-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1394">
<pre><code>(129, 1230)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1396">
<div class="sourceCode cell-code" id="cb426"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb426-1"><a href="#cb426-1"></a>nx.draw(G,with_labels<span class="op">=</span><span class="va">True</span>,font_weight<span class="op">=</span><span class="st">'bold'</span>,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">350</span>,font_color<span class="op">=</span><span class="st">'white'</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-267-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1590">
<div class="sourceCode cell-code" id="cb427"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb427-1"><a href="#cb427-1"></a>np.where(data[<span class="dv">2</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span>data[<span class="dv">2</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1590">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<div class="cell" data-execution_count="274">
<div class="sourceCode cell-code" id="cb429"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb429-1"><a href="#cb429-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> EnglandCovidDatasetLoader</span>
<span id="cb429-2"><a href="#cb429-2"></a>loader <span class="op">=</span> EnglandCovidDatasetLoader()</span>
<span id="cb429-3"><a href="#cb429-3"></a></span>
<span id="cb429-4"><a href="#cb429-4"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb429-5"><a href="#cb429-5"></a></span>
<span id="cb429-6"><a href="#cb429-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="275">
<div class="sourceCode cell-code" id="cb430"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb430-1"><a href="#cb430-1"></a>data<span class="op">=</span>[]</span>
<span id="cb430-2"><a href="#cb430-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb430-3"><a href="#cb430-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="276">
<div class="sourceCode cell-code" id="cb431"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb431-1"><a href="#cb431-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="276">
<pre><code>(tensor([-1.4697, -1.9283, -1.6990, -1.8137]), tensor(-1.8137))</code></pre>
</div>
</div>
<p><span class="math inline">\(t=0\)</span>에서 <span class="math inline">\(X\)</span>와 <span class="math inline">\(y\)</span>를 정리하면 아래와 같음.</p>
<ul>
<li>X:= <span class="math inline">\(x_0,x_1,x_2,x_3\)</span></li>
<li>y:= <span class="math inline">\(x_4\)</span></li>
</ul>
<div class="cell" data-execution_count="279">
<div class="sourceCode cell-code" id="cb433"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb433-1"><a href="#cb433-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="279">
<pre><code>(tensor([-1.9283, -1.6990, -1.8137, -1.8137]), tensor(-0.8965))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_1,x_2,x_3,x_4\)</span></li>
<li>y:= <span class="math inline">\(x_5\)</span></li>
</ul>
<div class="cell" data-execution_count="280">
<div class="sourceCode cell-code" id="cb435"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb435-1"><a href="#cb435-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">2</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="280">
<pre><code>(tensor([-1.6990, -1.8137, -1.8137, -0.8965]), tensor(-1.1258))</code></pre>
</div>
</div>
<ul>
<li>X:=<span class="math inline">\(x_2,x_3,x_4,x_5\)</span></li>
<li>y:=<span class="math inline">\(x_6\)</span></li>
</ul>
<p>하나의 노드에 길이가 <span class="math inline">\(T\)</span>인 시계열이 맵핑되어 있음. (노드는 총 129개)</p>
<p>각 노드마다 아래와 같은 과정으로 예측이 됨</p>
<ul>
<li><span class="math inline">\((x_0,x_1,x_2,x_3) \to (x_4)\)</span></li>
<li><span class="math inline">\((x_1,x_2,x_3,x_4) \to (x_5)\)</span></li>
</ul>
<p><span class="math inline">\(f(v,t), v \in \{v_1,\dots,v_{129}\}, t=1,2,\dots,52\)</span></p>
<p><span class="math display">\[{\bf X}_{t=1} = \begin{bmatrix}
f(v_1,t=1) &amp; f(v_1,t=2) &amp; f(v_1,t=3)&amp;  f(v_1,t=4) \\
f(v_2,t=1) &amp; f(v_2,t=2) &amp; f(v_2,t=3)&amp;  f(v_2,t=4) \\
\dots &amp; \dots  &amp; \dots &amp; \dots  \\
f(v_{20},t=1) &amp; f(v_{20},t=2) &amp; f(v_{20},t=3)&amp;  f(v_{20},t=4)
\end{bmatrix}\]</span></p>
<p><span class="math display">\[{\bf y}_{t=1} = \begin{bmatrix}
f(v_1,t=5) \\
f(v_2,t=5) \\
\dots  \\
f(v_{20},t=5)
\end{bmatrix}\]</span></p>
<section id="learn-8" class="level4">
<h4 class="anchored" data-anchor-id="learn-8">Learn</h4>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb437"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb437-1"><a href="#cb437-1"></a>model <span class="op">=</span> RecurrentGCN(node_features<span class="op">=</span><span class="dv">4</span>, filters<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb437-2"><a href="#cb437-2"></a></span>
<span id="cb437-3"><a href="#cb437-3"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb437-4"><a href="#cb437-4"></a></span>
<span id="cb437-5"><a href="#cb437-5"></a>model.train()</span>
<span id="cb437-6"><a href="#cb437-6"></a></span>
<span id="cb437-7"><a href="#cb437-7"></a><span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">50</span>)):</span>
<span id="cb437-8"><a href="#cb437-8"></a>    <span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb437-9"><a href="#cb437-9"></a>        y_hat <span class="op">=</span> model(snapshot.x, snapshot.edge_index, snapshot.edge_attr)</span>
<span id="cb437-10"><a href="#cb437-10"></a>        cost <span class="op">=</span> torch.mean((y_hat<span class="op">-</span>snapshot.y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb437-11"><a href="#cb437-11"></a>        cost.backward()</span>
<span id="cb437-12"><a href="#cb437-12"></a>        optimizer.step()</span>
<span id="cb437-13"><a href="#cb437-13"></a>        optimizer.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 50/50 [00:07&lt;00:00,  6.30it/s]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb439"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb439-1"><a href="#cb439-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb439-2"><a href="#cb439-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb439-3"><a href="#cb439-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb439-4"><a href="#cb439-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb439-5"><a href="#cb439-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb439-6"><a href="#cb439-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb440"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb440-1"><a href="#cb440-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>torch.Size([129, 4])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb442"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb442-1"><a href="#cb442-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>torch.Size([2, 2158])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb444"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb444-1"><a href="#cb444-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>torch.Size([2158])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb446"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb446-1"><a href="#cb446-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>torch.Size([129])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb448"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb448-1"><a href="#cb448-1"></a>y_hat.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>torch.Size([129, 1])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb450"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb450-1"><a href="#cb450-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<pre><code>torch.Size([129, 4])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li></li>
</ul>
<p>y</p>
<ul>
<li></li>
</ul>
<p>The node features correspond to the number of COVID-19 cases in the region in the past window days.</p>
<p>The task is to predict the number of cases in each node after 1 day</p>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb452"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb452-1"><a href="#cb452-1"></a>_x[<span class="dv">0</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>tensor([[-1.4697, -1.9283, -1.6990, -1.8137],
        [-1.2510, -1.1812, -1.3208, -1.1812],
        [-1.0934, -1.0934, -1.0934, -1.0934]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb454"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb454-1"><a href="#cb454-1"></a>_y[:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>tensor([-1.8137, -1.3208, -1.0934])</code></pre>
</div>
</div>
</section>
</section>
<section id="montevideobusdatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="montevideobusdatasetloader">MontevideoBusDatasetLoader</h2>
<p>https://www.fing.edu.uy/~renzom/msc/uploads/msc-thesis.pdf</p>
<p>A dataset of inflow passenger at bus stop level from Montevideo city. This dataset comprises hourly inflow passenger data at bus stop level for 11 bus lines during October 2020 from Montevideo city (Uruguay). The bus lines selected are the ones that carry people to the center of the city and they load more than 25% of the total daily inflow traffic. Vertices are bus stops, edges are links between bus stops when a bus line connects them and the weight represent the road distance. The target is the passenger inflow. This is a curated dataset made from different data sources of the Metropolitan Transportation System (STM) of Montevideo.</p>
<p>데이터정리</p>
<ul>
<li>T = 739</li>
<li>V = 버스정류장</li>
<li>N = 675 # number of nodes</li>
<li>E = 101761 = N^2 # edges</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (1,) # passenger inflow</li>
<li>시간에 따라서 Number of nodes가 변하는지? False</li>
<li>시간에 따라서 Number of nodes가 변하는지? False</li>
<li>X: (675,4) (N,4), <span class="math inline">\(f(v,t_0),f(v,t_1),f(v,t_2),f(v,t_3)\)</span></li>
<li>y: (675,,) (N,), <span class="math inline">\(f(v,t_4)\)</span></li>
<li>예제코드적용가능여부: Yes</li>
</ul>
<p><code>-</code> Nodes : <code>675</code></p>
<ul>
<li>vertices are bus stops</li>
</ul>
<p><code>-</code>Edges : <code>690</code></p>
<ul>
<li>edges are links between bus stops when a bus line connects them and the weight represent the road distance</li>
</ul>
<p><code>-</code> Time : <code>739</code></p>
<ul>
<li>hourly inflow passenger data at bus stop level for 11 bus lines during October 2020 from Montevideo city (Uruguay).</li>
</ul>
<div class="cell" data-execution_count="1591">
<div class="sourceCode cell-code" id="cb456"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb456-1"><a href="#cb456-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> MontevideoBusDatasetLoader</span>
<span id="cb456-2"><a href="#cb456-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb456-3"><a href="#cb456-3"></a></span>
<span id="cb456-4"><a href="#cb456-4"></a>loader <span class="op">=</span> MontevideoBusDatasetLoader()</span>
<span id="cb456-5"><a href="#cb456-5"></a></span>
<span id="cb456-6"><a href="#cb456-6"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb456-7"><a href="#cb456-7"></a></span>
<span id="cb456-8"><a href="#cb456-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1592">
<div class="sourceCode cell-code" id="cb457"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb457-1"><a href="#cb457-1"></a>data<span class="op">=</span>[]</span>
<span id="cb457-2"><a href="#cb457-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb457-3"><a href="#cb457-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1399">
<div class="sourceCode cell-code" id="cb458"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb458-1"><a href="#cb458-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1399">
<pre><code>739</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1400">
<div class="sourceCode cell-code" id="cb460"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb460-1"><a href="#cb460-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1400">
<pre><code>(torch.Size([675, 4]), torch.Size([2, 690]), torch.Size([690]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1401">
<div class="sourceCode cell-code" id="cb462"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb462-1"><a href="#cb462-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1402">
<div class="sourceCode cell-code" id="cb463"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb463-1"><a href="#cb463-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">675</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1403">
<div class="sourceCode cell-code" id="cb464"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb464-1"><a href="#cb464-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1404">
<div class="sourceCode cell-code" id="cb465"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb465-1"><a href="#cb465-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb465-2"><a href="#cb465-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">739</span>):</span>
<span id="cb465-3"><a href="#cb465-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])):</span>
<span id="cb465-4"><a href="#cb465-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1405">
<div class="sourceCode cell-code" id="cb466"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb466-1"><a href="#cb466-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1406">
<div class="sourceCode cell-code" id="cb467"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb467-1"><a href="#cb467-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1406">
<pre><code>(675, 690)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1410">
<div class="sourceCode cell-code" id="cb469"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb469-1"><a href="#cb469-1"></a>nx.draw(G,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">50</span>,font_color<span class="op">=</span><span class="st">'white'</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-294-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1593">
<div class="sourceCode cell-code" id="cb470"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb470-1"><a href="#cb470-1"></a>np.where(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">10</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1593">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<div class="cell" data-execution_count="281">
<div class="sourceCode cell-code" id="cb472"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb472-1"><a href="#cb472-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> MontevideoBusDatasetLoader</span>
<span id="cb472-2"><a href="#cb472-2"></a>loader <span class="op">=</span> MontevideoBusDatasetLoader()</span>
<span id="cb472-3"><a href="#cb472-3"></a></span>
<span id="cb472-4"><a href="#cb472-4"></a>dataset <span class="op">=</span> loader.get_dataset(lags<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb472-5"><a href="#cb472-5"></a></span>
<span id="cb472-6"><a href="#cb472-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="282">
<div class="sourceCode cell-code" id="cb473"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb473-1"><a href="#cb473-1"></a>data<span class="op">=</span>[]</span>
<span id="cb473-2"><a href="#cb473-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb473-3"><a href="#cb473-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="283">
<div class="sourceCode cell-code" id="cb474"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb474-1"><a href="#cb474-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="283">
<pre><code>(tensor([-0.4200, -0.4200, -0.4200, -0.4200]), tensor(-0.4200))</code></pre>
</div>
</div>
<p><span class="math inline">\(t=0\)</span>에서 <span class="math inline">\(X\)</span>와 <span class="math inline">\(y\)</span>를 정리하면 아래와 같음.</p>
<ul>
<li>X:= <span class="math inline">\(x_0,x_1,x_2,x_3\)</span></li>
<li>y:= <span class="math inline">\(x_4\)</span></li>
</ul>
<div class="cell" data-execution_count="284">
<div class="sourceCode cell-code" id="cb476"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb476-1"><a href="#cb476-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="284">
<pre><code>(tensor([-0.4200, -0.4200, -0.4200, -0.4200]), tensor(-0.4200))</code></pre>
</div>
</div>
<ul>
<li>X:= <span class="math inline">\(x_1,x_2,x_3,x_4\)</span></li>
<li>y:= <span class="math inline">\(x_5\)</span></li>
</ul>
<div class="cell" data-execution_count="285">
<div class="sourceCode cell-code" id="cb478"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb478-1"><a href="#cb478-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">2</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="285">
<pre><code>(tensor([-0.4200, -0.4200, -0.4200, -0.4200]), tensor(-0.4200))</code></pre>
</div>
</div>
<ul>
<li>X:=<span class="math inline">\(x_2,x_3,x_4,x_5\)</span></li>
<li>y:=<span class="math inline">\(x_6\)</span></li>
</ul>
<p>하나의 노드에 길이가 <span class="math inline">\(T\)</span>인 시계열이 맵핑되어 있음. (노드는 총 675개)</p>
<p>각 노드마다 아래와 같은 과정으로 예측이 됨</p>
<ul>
<li><span class="math inline">\((x_0,x_1,x_2,x_3) \to (x_4)\)</span></li>
<li><span class="math inline">\((x_1,x_2,x_3,x_4) \to (x_5)\)</span></li>
</ul>
<p><span class="math inline">\(f(v,t), v \in \{v_1,\dots,v_{675}\}, t=1,2,\dots,739\)</span></p>
<p><span class="math display">\[{\bf X}_{t=1} = \begin{bmatrix}
f(v_1,t=1) &amp; f(v_1,t=2) &amp; f(v_1,t=3)&amp;  f(v_1,t=4) \\
f(v_2,t=1) &amp; f(v_2,t=2) &amp; f(v_2,t=3)&amp;  f(v_2,t=4) \\
\dots &amp; \dots  &amp; \dots &amp; \dots  \\
f(v_{20},t=1) &amp; f(v_{20},t=2) &amp; f(v_{20},t=3)&amp;  f(v_{20},t=4)
\end{bmatrix}\]</span></p>
<p><span class="math display">\[{\bf y}_{t=1} = \begin{bmatrix}
f(v_1,t=5) \\
f(v_2,t=5) \\
\dots  \\
f(v_{20},t=5)
\end{bmatrix}\]</span></p>
<section id="learn-9" class="level4">
<h4 class="anchored" data-anchor-id="learn-9">Learn</h4>
<div class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb480"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb480-1"><a href="#cb480-1"></a>model <span class="op">=</span> RecurrentGCN(node_features<span class="op">=</span><span class="dv">4</span>, filters<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb480-2"><a href="#cb480-2"></a></span>
<span id="cb480-3"><a href="#cb480-3"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb480-4"><a href="#cb480-4"></a></span>
<span id="cb480-5"><a href="#cb480-5"></a>model.train()</span>
<span id="cb480-6"><a href="#cb480-6"></a></span>
<span id="cb480-7"><a href="#cb480-7"></a><span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">50</span>)):</span>
<span id="cb480-8"><a href="#cb480-8"></a>    <span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb480-9"><a href="#cb480-9"></a>        y_hat <span class="op">=</span> model(snapshot.x, snapshot.edge_index, snapshot.edge_attr)</span>
<span id="cb480-10"><a href="#cb480-10"></a>        cost <span class="op">=</span> torch.mean((y_hat<span class="op">-</span>snapshot.y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb480-11"><a href="#cb480-11"></a>        cost.backward()</span>
<span id="cb480-12"><a href="#cb480-12"></a>        optimizer.step()</span>
<span id="cb480-13"><a href="#cb480-13"></a>        optimizer.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 50/50 [01:51&lt;00:00,  2.23s/it]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb482"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb482-1"><a href="#cb482-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb482-2"><a href="#cb482-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb482-3"><a href="#cb482-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb482-4"><a href="#cb482-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb482-5"><a href="#cb482-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb482-6"><a href="#cb482-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb483"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb483-1"><a href="#cb483-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>torch.Size([675, 4])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb485"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb485-1"><a href="#cb485-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>torch.Size([2, 690])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb487"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb487-1"><a href="#cb487-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>torch.Size([690])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb489"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb489-1"><a href="#cb489-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>torch.Size([675])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb491"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb491-1"><a href="#cb491-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="105">
<pre><code>torch.Size([675, 4])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li></li>
</ul>
<p>y</p>
<ul>
<li>The target is the passenger inflow.</li>
<li>This is a curated dataset made from different data sources of the Metropolitan Transportation System (STM) of Montevide</li>
</ul>
<div class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb493"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb493-1"><a href="#cb493-1"></a>_x[<span class="dv">0</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>tensor([[-0.4200, -0.4200, -0.4200, -0.4200],
        [-0.0367, -0.0367, -0.0367, -0.0367],
        [-0.2655, -0.2655, -0.2655, -0.2655]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb495"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb495-1"><a href="#cb495-1"></a>_y[:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>tensor([-0.4200, -0.0367, -0.2655])</code></pre>
</div>
</div>
</section>
</section>
<section id="twittertennisdatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="twittertennisdatasetloader">TwitterTennisDatasetLoader</h2>
<p>https://appliednetsci.springeropen.com/articles/10.1007/s41109-018-0080-5?ref=https://githubhelp.com</p>
<p>Twitter mention graphs related to major tennis tournaments from 2017. Nodes are Twitter accounts and edges are mentions between them. Each snapshot contains the graph induced by the most popular nodes of the original dataset. Node labels encode the number of mentions received in the original dataset for the next snapshot. Read more on the original Twitter data in the ‘Temporal Walk Based Centrality Metric for Graph Streams’ paper.</p>
<p>데이터정리</p>
<ul>
<li>T = 52081</li>
<li>V = 트위터계정<br>
</li>
<li>N = 1000 # number of nodes</li>
<li>E = 119 = N^2 # edges</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (1,) # passenger inflow</li>
<li>시간에 따라서 N이 변하는지? ??</li>
<li>시간에 따라서 E가 변하는지? True</li>
<li>X: ?</li>
<li>y: ?</li>
<li>예제코드적용가능여부: No</li>
</ul>
<p><code>-</code> Nodes : <code>1000</code></p>
<ul>
<li>vertices are Twitter accounts</li>
</ul>
<p><code>-</code>Edges : <code>119</code></p>
<ul>
<li>edges are mentions between them</li>
</ul>
<p><code>-</code> Time : <code>52081</code></p>
<ul>
<li>Twitter mention graphs related to major tennis tournaments from 2017</li>
</ul>
<div class="cell" data-execution_count="1621">
<div class="sourceCode cell-code" id="cb497"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb497-1"><a href="#cb497-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> TwitterTennisDatasetLoader</span>
<span id="cb497-2"><a href="#cb497-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb497-3"><a href="#cb497-3"></a></span>
<span id="cb497-4"><a href="#cb497-4"></a>loader <span class="op">=</span> TwitterTennisDatasetLoader()</span>
<span id="cb497-5"><a href="#cb497-5"></a></span>
<span id="cb497-6"><a href="#cb497-6"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb497-7"><a href="#cb497-7"></a></span>
<span id="cb497-8"><a href="#cb497-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1622">
<div class="sourceCode cell-code" id="cb498"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb498-1"><a href="#cb498-1"></a>data<span class="op">=</span>[]</span>
<span id="cb498-2"><a href="#cb498-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb498-3"><a href="#cb498-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1623">
<div class="sourceCode cell-code" id="cb499"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb499-1"><a href="#cb499-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1623">
<pre><code>119</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1624">
<div class="sourceCode cell-code" id="cb501"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb501-1"><a href="#cb501-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1624">
<pre><code>(torch.Size([1000, 16]), torch.Size([2, 89]), torch.Size([89]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1630">
<div class="sourceCode cell-code" id="cb503"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb503-1"><a href="#cb503-1"></a>data[<span class="dv">0</span>][<span class="dv">1</span>].x[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1630">
<pre><code>tensor([0., 0., 0., 0., 1., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1631">
<div class="sourceCode cell-code" id="cb505"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb505-1"><a href="#cb505-1"></a>data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1631">
<pre><code>tensor([ 42, 909, 909, 909, 233, 233, 450, 256, 256, 256, 256, 256, 434, 434,
        434, 233, 233, 233, 233, 233, 233, 233,   9,   9, 355,  84,  84,  84,
         84, 140, 140, 140, 140,   0, 140, 238, 238, 238, 649, 875, 875, 234,
         73,  73, 341, 341, 341, 341, 341, 417, 293, 991,  74, 581, 282, 162,
        144, 383, 383, 135, 135, 910, 910, 910, 910, 910,  87,  87,  87,  87,
          9,   9, 934, 934, 162, 225,  42, 911, 911, 911, 911, 911, 911, 911,
        911, 498, 498,  64, 435])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1633">
<div class="sourceCode cell-code" id="cb507"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb507-1"><a href="#cb507-1"></a>data[<span class="dv">0</span>][<span class="dv">1</span>].edge_attr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1633">
<pre><code>tensor([2., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
        1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
        1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 2., 1., 1., 1., 1., 1.,
        1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 2., 2., 1., 1., 1., 1., 1., 1.,
        1., 1., 1., 1., 3., 2., 1., 1., 1., 1., 2., 2., 2., 1., 1., 1., 3.])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1438">
<div class="sourceCode cell-code" id="cb509"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb509-1"><a href="#cb509-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1439">
<div class="sourceCode cell-code" id="cb510"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb510-1"><a href="#cb510-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">1000</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1440">
<div class="sourceCode cell-code" id="cb511"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb511-1"><a href="#cb511-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1441">
<div class="sourceCode cell-code" id="cb512"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb512-1"><a href="#cb512-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb512-2"><a href="#cb512-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">119</span>):</span>
<span id="cb512-3"><a href="#cb512-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">40</span>):</span>
<span id="cb512-4"><a href="#cb512-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1442">
<div class="sourceCode cell-code" id="cb513"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb513-1"><a href="#cb513-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1443">
<div class="sourceCode cell-code" id="cb514"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb514-1"><a href="#cb514-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1443">
<pre><code>(1000, 2819)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1444">
<div class="sourceCode cell-code" id="cb516"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb516-1"><a href="#cb516-1"></a>nx.draw(G,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">50</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-323-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1603">
<div class="sourceCode cell-code" id="cb517"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb517-1"><a href="#cb517-1"></a><span class="bu">len</span>(data[<span class="dv">2</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1603">
<pre><code>67</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1606">
<div class="sourceCode cell-code" id="cb519"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb519-1"><a href="#cb519-1"></a><span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1606">
<pre><code>89</code></pre>
</div>
</div>
<p>다름..</p>
<hr>
<div class="cell" data-execution_count="296">
<div class="sourceCode cell-code" id="cb521"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb521-1"><a href="#cb521-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> TwitterTennisDatasetLoader</span>
<span id="cb521-2"><a href="#cb521-2"></a>loader <span class="op">=</span> TwitterTennisDatasetLoader()</span>
<span id="cb521-3"><a href="#cb521-3"></a></span>
<span id="cb521-4"><a href="#cb521-4"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb521-5"><a href="#cb521-5"></a></span>
<span id="cb521-6"><a href="#cb521-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="297">
<div class="sourceCode cell-code" id="cb522"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb522-1"><a href="#cb522-1"></a>data<span class="op">=</span>[]</span>
<span id="cb522-2"><a href="#cb522-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb522-3"><a href="#cb522-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="298">
<div class="sourceCode cell-code" id="cb523"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb523-1"><a href="#cb523-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="298">
<pre><code>(tensor([0., 0., 0., 0., 1., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]),
 tensor(4.8363))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="299">
<div class="sourceCode cell-code" id="cb525"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb525-1"><a href="#cb525-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="299">
<pre><code>(tensor([0., 0., 0., 1., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]),
 tensor(4.9200))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="300">
<div class="sourceCode cell-code" id="cb527"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb527-1"><a href="#cb527-1"></a>(data[<span class="dv">2</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">2</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="300">
<pre><code>(tensor([0., 0., 0., 0., 1., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]),
 tensor(6.5539))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="301">
<div class="sourceCode cell-code" id="cb529"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb529-1"><a href="#cb529-1"></a>(data[<span class="dv">3</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">3</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="301">
<pre><code>(tensor([0., 0., 0., 0., 1., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]),
 tensor(6.9651))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb531"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb531-1"><a href="#cb531-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb531-2"><a href="#cb531-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb531-3"><a href="#cb531-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb531-4"><a href="#cb531-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb531-5"><a href="#cb531-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb531-6"><a href="#cb531-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb532"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb532-1"><a href="#cb532-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="118">
<pre><code>torch.Size([1000, 16])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb534"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb534-1"><a href="#cb534-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre><code>torch.Size([2, 89])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb536"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb536-1"><a href="#cb536-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre><code>torch.Size([89])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb538"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb538-1"><a href="#cb538-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="121">
<pre><code>torch.Size([1000])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb540"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb540-1"><a href="#cb540-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="122">
<pre><code>torch.Size([1000, 16])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li></li>
</ul>
<p>y</p>
<ul>
<li></li>
</ul>
<div class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb542"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb542-1"><a href="#cb542-1"></a>_x[<span class="dv">0</span>:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="123">
<pre><code>tensor([[0., 0., 0., 0., 1., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 1., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 1., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb544"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb544-1"><a href="#cb544-1"></a>_y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="125">
<pre><code>tensor(4.8363)</code></pre>
</div>
</div>
</section>
<section id="mtmdatasetloader" class="level2">
<h2 class="anchored" data-anchor-id="mtmdatasetloader">MTMDatasetLoader</h2>
<p>A dataset of Methods-Time Measurement-1 (MTM-1) motions, signalled as consecutive video frames of 21 3D hand keypoints, acquired via MediaPipe Hands from RGB-Video material. Vertices are the finger joints of the human hand and edges are the bones connecting them. The targets are manually labeled for each frame, according to one of the five MTM-1 motions (classes ): Grasp, Release, Move, Reach, Position plus a negative class for frames without graph signals (no hand present). This is a classification task where consecutive frames need to be assigned to the corresponding class . The data x is returned in shape (3, 21, T), the target is returned one-hot-encoded in shape (T, 6).</p>
<p>데이터정리</p>
<ul>
<li>T = 14452</li>
<li>V = 손의 shape에 대응하는 dot<br>
</li>
<li>N = 325 # number of nodes</li>
<li>E = 19 = N^2 # edges</li>
<li><span class="math inline">\(f(v,t)\)</span>의 차원? (Grasp, Release, Move, Reach, Poision, -1)</li>
<li>시간에 따라서 N이 변하는지? ??</li>
<li>시간에 따라서 E가 변하는지? ??</li>
<li>X: ?</li>
<li>y: ?</li>
<li>예제코드적용가능여부: No</li>
</ul>
<p><code>-</code> Nodes : <code>325</code></p>
<ul>
<li>vertices are are the finger joints of the human hand</li>
</ul>
<p><code>-</code>Edges : <code>19</code></p>
<ul>
<li>edges are the bones connecting them</li>
</ul>
<p><code>-</code> Time : <code>14452</code></p>
<div class="cell" data-execution_count="1607">
<div class="sourceCode cell-code" id="cb546"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb546-1"><a href="#cb546-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> MTMDatasetLoader</span>
<span id="cb546-2"><a href="#cb546-2"></a><span class="im">from</span> torch_geometric_temporal.signal <span class="im">import</span> temporal_signal_split</span>
<span id="cb546-3"><a href="#cb546-3"></a></span>
<span id="cb546-4"><a href="#cb546-4"></a>loader <span class="op">=</span> MTMDatasetLoader()</span>
<span id="cb546-5"><a href="#cb546-5"></a></span>
<span id="cb546-6"><a href="#cb546-6"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb546-7"><a href="#cb546-7"></a></span>
<span id="cb546-8"><a href="#cb546-8"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1608">
<div class="sourceCode cell-code" id="cb547"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb547-1"><a href="#cb547-1"></a>data<span class="op">=</span>[]</span>
<span id="cb547-2"><a href="#cb547-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb547-3"><a href="#cb547-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1609">
<div class="sourceCode cell-code" id="cb548"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb548-1"><a href="#cb548-1"></a>time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1609">
<pre><code>14452</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1448">
<div class="sourceCode cell-code" id="cb550"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb550-1"><a href="#cb550-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_index.shape,(data[<span class="dv">0</span>][<span class="dv">1</span>]).edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1448">
<pre><code>(torch.Size([3, 21, 16]), torch.Size([2, 19]), torch.Size([19]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1449">
<div class="sourceCode cell-code" id="cb552"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb552-1"><a href="#cb552-1"></a>G <span class="op">=</span> nx.Graph()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1450">
<div class="sourceCode cell-code" id="cb553"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb553-1"><a href="#cb553-1"></a>node_list <span class="op">=</span> torch.tensor(<span class="bu">range</span>(<span class="dv">21</span>)).tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1451">
<div class="sourceCode cell-code" id="cb554"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb554-1"><a href="#cb554-1"></a>G.add_nodes_from(node_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1453">
<div class="sourceCode cell-code" id="cb555"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb555-1"><a href="#cb555-1"></a>edge_list<span class="op">=</span>[]</span>
<span id="cb555-2"><a href="#cb555-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">14452</span>):</span>
<span id="cb555-3"><a href="#cb555-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index[<span class="dv">0</span>])):</span>
<span id="cb555-4"><a href="#cb555-4"></a>        edge_list.append([data[i][<span class="dv">1</span>].edge_index[<span class="dv">0</span>][j].tolist(),data[i][<span class="dv">1</span>].edge_index[<span class="dv">1</span>][j].tolist()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1454">
<div class="sourceCode cell-code" id="cb556"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb556-1"><a href="#cb556-1"></a>G.add_edges_from(edge_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="1455">
<div class="sourceCode cell-code" id="cb557"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb557-1"><a href="#cb557-1"></a>G.number_of_nodes(),G.number_of_edges()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1455">
<pre><code>(21, 19)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1457">
<div class="sourceCode cell-code" id="cb559"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb559-1"><a href="#cb559-1"></a>nx.draw(G,with_labels<span class="op">=</span><span class="va">True</span>,font_weight<span class="op">=</span><span class="st">'bold'</span>,node_color<span class="op">=</span><span class="st">'green'</span>,node_size<span class="op">=</span><span class="dv">350</span>,font_color<span class="op">=</span><span class="st">'white'</span>,width<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-02-11-STGCN-튜토리얼(최서연)_files/figure-html/cell-350-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
<p>time별 같은 edge 정보를 가지고 있나 확인</p>
<div class="cell" data-execution_count="1611">
<div class="sourceCode cell-code" id="cb560"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb560-1"><a href="#cb560-1"></a>np.where(data[<span class="dv">0</span>][<span class="dv">1</span>].edge_index <span class="op">!=</span> data[<span class="dv">12</span>][<span class="dv">1</span>].edge_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1611">
<pre><code>(array([], dtype=int64), array([], dtype=int64))</code></pre>
</div>
</div>
<hr>
<div class="cell" data-execution_count="303">
<div class="sourceCode cell-code" id="cb562"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb562-1"><a href="#cb562-1"></a><span class="im">from</span> torch_geometric_temporal.dataset <span class="im">import</span> MTMDatasetLoader</span>
<span id="cb562-2"><a href="#cb562-2"></a>loader <span class="op">=</span> MTMDatasetLoader()</span>
<span id="cb562-3"><a href="#cb562-3"></a></span>
<span id="cb562-4"><a href="#cb562-4"></a>dataset <span class="op">=</span> loader.get_dataset()</span>
<span id="cb562-5"><a href="#cb562-5"></a></span>
<span id="cb562-6"><a href="#cb562-6"></a>train_dataset, test_dataset <span class="op">=</span> temporal_signal_split(dataset, train_ratio<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="304">
<div class="sourceCode cell-code" id="cb563"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb563-1"><a href="#cb563-1"></a>data<span class="op">=</span>[]</span>
<span id="cb563-2"><a href="#cb563-2"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb563-3"><a href="#cb563-3"></a>    data.append([time,snapshot])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="305">
<div class="sourceCode cell-code" id="cb564"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb564-1"><a href="#cb564-1"></a>(data[<span class="dv">0</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>], (data[<span class="dv">0</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="305">
<pre><code>(tensor([[0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]]),
 tensor([0., 0., 1., 0., 0., 0.]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="306">
<div class="sourceCode cell-code" id="cb566"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb566-1"><a href="#cb566-1"></a>(data[<span class="dv">1</span>][<span class="dv">1</span>]).x[<span class="dv">0</span>],(data[<span class="dv">1</span>][<span class="dv">1</span>]).y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="306">
<pre><code>(tensor([[0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]]),
 tensor([0., 0., 1., 0., 0., 0.]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb568"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb568-1"><a href="#cb568-1"></a><span class="cf">for</span> time, snapshot <span class="kw">in</span> <span class="bu">enumerate</span>(train_dataset):</span>
<span id="cb568-2"><a href="#cb568-2"></a>    _x <span class="op">=</span> snapshot.x </span>
<span id="cb568-3"><a href="#cb568-3"></a>    _edge_index <span class="op">=</span> snapshot.edge_index </span>
<span id="cb568-4"><a href="#cb568-4"></a>    _edge_attr <span class="op">=</span> snapshot.edge_attr</span>
<span id="cb568-5"><a href="#cb568-5"></a>    _y <span class="op">=</span> snapshot.y</span>
<span id="cb568-6"><a href="#cb568-6"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb569"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb569-1"><a href="#cb569-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="130">
<pre><code>torch.Size([3, 21, 16])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb571"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb571-1"><a href="#cb571-1"></a>_edge_index.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="131">
<pre><code>torch.Size([2, 19])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb573"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb573-1"><a href="#cb573-1"></a>_edge_attr.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="132">
<pre><code>torch.Size([19])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb575"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb575-1"><a href="#cb575-1"></a>_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre><code>torch.Size([16, 6])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb577"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb577-1"><a href="#cb577-1"></a>_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="134">
<pre><code>torch.Size([3, 21, 16])</code></pre>
</div>
</div>
<p>x</p>
<ul>
<li>The data x is returned in shape (3, 21, T),</li>
</ul>
<p>y</p>
<ul>
<li>The targets are manually labeled for each frame, according to one of the five MTM-1 motions (classes ): Grasp, Release, Move, Reach, Position plus a negative class for frames without graph signals (no hand present).</li>
<li>the target is returned one-hot-encoded in shape (T, 6).</li>
</ul>
<div class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb579"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb579-1"><a href="#cb579-1"></a>_x[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="143">
<pre><code>tensor([[0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb581"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb581-1"><a href="#cb581-1"></a>_y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="137">
<pre><code>tensor([0., 0., 1., 0., 0., 0.])</code></pre>
</div>
</div>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>일반적인 기하학적 딥러닝을 위한 파이토치 패키지<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>STGCN을 위한 패키지<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="miruetoto/yechan3" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>